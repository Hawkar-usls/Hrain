<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pocket L2 Idle ‚Äî MMO Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Roboto:wght@400;700&display=swap');
    
    body,html{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#000;color:#fff;font-family:'Roboto', sans-serif; -webkit-user-select: none; user-select: none;}
    
    #menu { position: absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background: radial-gradient(circle, #2a0066 0%, #0a001f 100%); z-index: 2000; }
    #game { display: none; width: 100%; height: 100%; position: relative; }
    #phaser-game { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
    
    /* UI */
    #stats {
        position: absolute; top: 10px; left: 10px;
        background: rgba(0, 0, 0, 0.6); /* –ë–æ–ª–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
        backdrop-filter: blur(4px); /* –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ */
        border: 1px solid rgba(74, 0, 114, 0.5);
        border-radius: 12px;
        padding: 10px; z-index: 100; width: 220px; font-size: 11px;
        max-height: 60vh; overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .bar-container { width: 100%; height: 6px; background: #222; margin: 2px 0; border-radius: 3px; overflow: hidden; }
    .bar-fill { height: 100%; transition: width 0.3s; }
    
    .ui-btn {
        width: 100%; padding: 8px 0; margin-top: 4px;
        background: rgba(55, 65, 81, 0.8); border: 1px solid #4b5563; border-radius: 6px;
        color: #e5e7eb; font-weight: bold; font-size: 11px; cursor: pointer; text-align: center; display: block;
        transition: all 0.2s;
    }
    .ui-btn:active { background: #4b5563; transform: scale(0.98); }
    
    #skills {
        position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
        display: flex; gap: 12px; z-index: 100;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        padding: 10px; border-radius: 16px; border: 1px solid #555;
    }
    .skill-btn {
        width: 56px; height: 56px; border-radius: 12px; border: 2px solid #777;
        font-size: 24px; display: flex; align-items: center; justify-content: center;
        background: rgba(34, 34, 34, 0.8); position: relative; cursor: pointer; transition: transform 0.1s;
    }
    .skill-btn:active { transform: scale(0.95); }
    
    /* –ú–æ–¥–∞–ª–∫–∏ */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
    .modal-content { width: 90%; max-width: 400px; background: #1f2937; border: 1px solid #6d28d9; border-radius: 12px; padding: 15px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
    
    .floating-text { position: absolute; font-weight: bold; pointer-events: none; text-shadow: 1px 1px 0 #000; animation: floatUp 1.5s forwards; z-index: 1000; }
    @keyframes floatUp { to { transform: translateY(-50px); opacity: 0; } }
    
    .item-slot, .craft-item, .auction-item, .mail-item, .quest-item { background: #374151; border-radius: 6px; padding: 8px; margin-bottom: 6px; }
</style>
</head>
<body>

<div id="menu">
    <h1 style="font-family: 'Cinzel', serif; font-size: 3rem; color: #a78bfa; text-shadow: 0 0 20px #7c3aed; margin-bottom: 20px;">Pocket L2</h1>
    <div class="flex flex-col gap-4 w-64">
        <input id="name" placeholder="–ò–º—è –≥–µ—Ä–æ—è" class="p-3 rounded bg-gray-800 text-white border border-gray-600 text-center">
        <select id="cls" class="p-3 rounded bg-gray-800 text-white border border-gray-600">
            <option value="gladiator">Gladiator (–í–æ–∏–Ω)</option>
            <option value="sorcerer">Sorcerer (–ú–∞–≥)</option>
            <option value="hawkeye">Hawkeye (–õ—É–∫)</option>
        </select>
        <button onclick="window.startGameWrapper()" class="p-4 rounded bg-purple-600 font-bold text-white hover:bg-purple-500 transition shadow-[0_0_15px_rgba(124,58,237,0.5)]">–ù–ê–ß–ê–¢–¨</button>
    </div>
</div>

<div id="game">
    <div id="phaser-game"></div>

    <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="stats">
        <div id="pname" class="text-yellow-400 font-bold mb-1 text-sm">...</div>
        <div class="bar-container"><div id="hp" class="bar-fill bg-red-600" style="width: 100%"></div></div>
        <div class="bar-container"><div id="mp" class="bar-fill bg-blue-600" style="width: 100%"></div></div>
        <div class="flex justify-between text-[10px] text-gray-400"><span>LVL <span id="lvl">1</span></span><span><span id="adena" class="text-yellow-300">0</span> A</span></div>

        <hr class="border-gray-600 my-2">
        
        <div class="grid grid-cols-2 gap-2">
            <button onclick="mainScript.toggleSS()" id="ss-btn" class="ui-btn border-yellow-600 text-yellow-500">SS</button>
            <button onclick="mainScript.toggleFarm()" id="farm-btn" class="ui-btn border-green-600 text-green-500">–§–∞—Ä–º</button>
        </div>
        <button onclick="mainScript.toggleEquipment()" class="ui-btn bg-cyan-900 border-cyan-700">üõ°Ô∏è –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞</button>
        <div class="grid grid-cols-2 gap-2">
            <button onclick="mainScript.toggleInventory()" class="ui-btn">üéí –°—É–º–∫–∞</button>
            <button onclick="mainScript.toggleQuestLog()" class="ui-btn">üìú –ö–≤–µ—Å—Ç—ã</button>
        </div>
        <button onclick="mainScript.toggleAuctionHouse()" class="ui-btn">‚öñÔ∏è –ê—É–∫—Ü–∏–æ–Ω</button>
        <button onclick="mainScript.toggleCrafting()" class="ui-btn text-pink-400 border-pink-900">‚öíÔ∏è –ö—Ä–∞—Ñ—Ç</button>
    </div>

    <div id="skills">
        <div class="skill-btn" id="skill1" onclick="mainScript.useSkill(1)">1</div>
        <div class="skill-btn" id="skill2" onclick="mainScript.useSkill(2)">2</div>
        <div class="skill-btn" id="skill3" onclick="mainScript.useSkill(3)">3</div>
    </div>

    <div id="particles"></div>

    <div id="generic-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-center font-bold text-xl mb-4 text-purple-300"></h3>
            <div id="modal-body" class="flex-grow overflow-y-auto bg-gray-900 p-2 rounded mb-4 text-sm"></div>
            <button onclick="document.getElementById('generic-modal').style.display='none'" class="bg-red-600 p-3 rounded w-full font-bold">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<!-- –õ–æ–≥–∏–∫–∞ -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, query, orderBy, limit, addDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const game = {
        p: {}, phaser: null, scene: null,
        ITEMS: {
            'D_Sword': { name: '–ú–µ—á –†—ã—Ü–∞—Ä—è (D)', type: 'Wpn', slot: 'weapon', stats: {atk:15} },
            'C_Bow': { name: '–≠–ª—å—Ñ. –õ—É–∫ (C)', type: 'Wpn', slot: 'weapon', stats: {atk:35} },
            'B_Robe': { name: '–†–æ–±–∞ –ú–∞–≥–∞ (B)', type: 'Arm', slot: 'armor', stats: {hp:100} },
            'Bone': { name: '–ö–æ—Å—Ç—å', type: 'Res' }, 'Thread': { name: '–ù–∏—Ç—å', type: 'Res' }
        },
        sprites: { player: null, mobs: [], npcs: [] },
        target: null,

        init: async function(uid) {
            const ref = doc(db, `artifacts/${appId}/users/${uid}/profile/data`);
            const snap = await getDoc(ref);
            const d = snap.exists() ? snap.data() : {};
            this.p = {
                name: document.getElementById('name').value || '–ì–µ—Ä–æ–π', cls: document.getElementById('cls').value, uid: uid,
                x: 1600, y: 1600, hp: 100, maxHp: 100, level: 1, adena: 0,
                inv: {'Bone': 5}, equip: {weapon: null}, autoFarm: false,
                ...d
            };
            this.calcStats();
            this.launchPhaser();
            this.startLoop();
        },

        calcStats: function() {
            this.p.maxHp = 100 + (this.p.level * 20);
            document.getElementById('pname').innerText = this.p.name;
            document.getElementById('lvl').innerText = this.p.level;
            document.getElementById('adena').innerText = this.p.adena;
        },

        launchPhaser: function() {
            document.getElementById('menu').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            const config = {
                type: Phaser.AUTO, parent: 'phaser-game', width: window.innerWidth, height: window.innerHeight,
                pixelArt: true, backgroundColor: '#000', physics: { default: 'arcade', arcade: { debug: false } },
                scene: [MainScene]
            };
            if(this.phaser) this.phaser.destroy(true);
            this.phaser = new Phaser.Game(config);
            
            window.addEventListener('resize', () => {
                if(this.phaser) this.phaser.scale.resize(window.innerWidth, window.innerHeight);
            });
        },

        startLoop: function() {
            setInterval(() => {
                if (!this.p.uid) return;
                if(this.p.hp < this.p.maxHp) this.p.hp += 0.5;
                document.getElementById('hp').style.width = (this.p.hp / this.p.maxHp * 100) + '%';
                if(Date.now() % 5000 < 1000) this.save();
            }, 1000);
        },

        save: async function() {
            if(!this.p.uid) return;
            try { await setDoc(doc(db, `artifacts/${appId}/users/${this.p.uid}/profile/data`), this.p, {merge: true}); } catch(e){}
        },
        
        toggleInventory: () => openModal('–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å', Object.entries(game.p.inv).map(([k,v]) => `<div class="item-slot flex justify-between"><span>${game.ITEMS[k]?game.ITEMS[k].name:k}</span><span>x${v}</span></div>`).join('')),
        toggleEquipment: () => openModal('–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞', `Weapon: ${game.p.equip.weapon || '–ù–µ—Ç'}<br>Armor: ${game.p.equip.armor || '–ù–µ—Ç'}`),
        toggleChat: () => alert('–ß–∞—Ç –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ'),
        toggleQuestLog: () => openModal('–ö–≤–µ—Å—Ç—ã', '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–≤–µ—Å—Ç–æ–≤'),
        toggleMailbox: () => openModal('–ü–æ—á—Ç–∞', '–ü—É—Å—Ç–æ'),
        toggleAuctionHouse: () => openModal('–ê—É–∫—Ü–∏–æ–Ω', '–†—ã–Ω–æ–∫ –ø—É—Å—Ç'),
        toggleCrafting: () => openModal('–ö—Ä–∞—Ñ—Ç', '–ö—É–∑–Ω–µ—Ü –æ—Ç–¥—ã—Ö–∞–µ—Ç'),
        toggleSS: () => { const b = document.getElementById('ss-btn'); b.classList.toggle('text-yellow-500'); b.innerText = b.innerText==='SS' ? 'SS: ON' : 'SS'; },
        toggleFarm: () => { game.p.autoFarm = !game.p.autoFarm; const b=document.getElementById('farm-btn'); b.classList.toggle('text-green-500'); b.innerText = game.p.autoFarm ? '–§–∞—Ä–º: ON' : '–§–∞—Ä–º'; },
        useSkill: (id) => { 
            if(!game.sprites.player) return;
            const circle = game.scene.add.circle(game.sprites.player.x, game.sprites.player.y, 60, 0xff00ff, 0.4);
            game.scene.tweens.add({targets:circle, scale:2, alpha:0, duration:400, onComplete:()=>circle.destroy()});
        }
    };

    function openModal(title, html) {
        const m = document.getElementById('generic-modal');
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-body').innerHTML = html || '–ü—É—Å—Ç–æ';
        m.style.display = 'flex';
    }

    window.mainScript = game;
    window.startGameWrapper = () => {
        const app = initializeApp(JSON.parse(window.firebaseConfig));
        window.db = getFirestore(app);
        const auth = getAuth(app);
        onAuthStateChanged(auth, (u) => { if (u) game.init(u.uid); else signInAnonymously(auth); });
    };
    window.firebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
    window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default';

    // === PHASER SCENE (–° –ü–†–û–¶–ï–î–£–†–ù–û–ô –ì–†–ê–§–ò–ö–û–ô) ===
    class MainScene extends Phaser.Scene {
        preload() {
            // –ú—ã –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —á–µ—Ä–Ω—ã—Ö –∫–≤–∞–¥—Ä–∞—Ç–æ–≤.
            // –ú—ã —Å–æ–∑–¥–∞–¥–∏–º —Ç–µ–∫—Å—Ç—É—Ä—ã –ø—Ä—è–º–æ –∑–¥–µ—Å—å.
        }
        
        create() {
            game.scene = this;
            
            // 1. –ì–ï–ù–ï–†–ê–¶–ò–Ø –¢–ï–ö–°–¢–£–† "–ù–ê –õ–ï–¢–£" (Failsafe –º–µ—Ç–æ–¥)
            // –ò–≥—Ä–æ–∫ (–ë–µ–ª—ã–π)
            let g = this.make.graphics({x:0, y:0, add:false});
            g.fillStyle(0xffffff); g.fillRect(0,0,32,32); // –¢–µ–ª–æ
            g.fillStyle(0x000000); g.fillRect(8,8,4,4); g.fillRect(20,8,4,4); // –ì–ª–∞–∑–∞
            g.fillStyle(0xcccccc); g.fillRect(4,20,24,4); // –†–æ—Ç/–ó–∞—â–∏—Ç–∞
            g.generateTexture('player', 32, 32);

            // –ú–æ–± (–ö—Ä–∞—Å–Ω—ã–π –ø–∞—É–∫)
            g.clear();
            g.fillStyle(0xcc0000); g.fillCircle(16,16,14); // –¢–µ–ª–æ
            g.fillStyle(0xffff00); g.fillCircle(12,12,4); g.fillCircle(20,12,4); // –ì–ª–∞–∑–∞
            g.lineStyle(2, 0xcc0000); 
            g.beginPath(); g.moveTo(0,0); g.lineTo(10,10); g.strokePath(); // –ù–æ–≥–∏ (—É—Å–ª–æ–≤–Ω–æ)
            g.generateTexture('mob', 32, 32);

            // NPC (–ó–µ–ª–µ–Ω—ã–π)
            g.clear();
            g.fillStyle(0x00ff00); g.fillRect(4,4,24,24);
            g.fillStyle(0xffffff); g.fillRect(10,8,12,4); // –û—á–∫–∏
            g.generateTexture('npc', 32, 32);

            // –¢—Ä–∞–≤–∞ –∏ –ö–∞–º–µ–Ω—å (–¢–∞–π–ª—ã)
            g.clear();
            g.fillStyle(0x2d6e32); g.fillRect(0,0,32,32); // –¢—Ä–∞–≤–∞ –±–∞–∑–∞
            g.fillStyle(0x3e8e41); g.fillRect(4,4,4,4); g.fillRect(20,20,4,4); // –¢—Ä–∞–≤–∏–Ω–∫–∏
            g.generateTexture('tile_grass', 32, 32);

            g.clear();
            g.fillStyle(0x555555); g.fillRect(0,0,32,32); // –ö–∞–º–µ–Ω—å –±–∞–∑–∞
            g.fillStyle(0x666666); g.fillRect(2,2,28,28); // –ü–ª–∏—Ç–∫–∞
            g.generateTexture('tile_stone', 32, 32);
            
            g.clear();
            g.fillStyle(0x222222); g.fillRect(0,0,32,32); // –°—Ç–µ–Ω–∞
            g.lineStyle(2, 0x444444); g.strokeRect(0,0,32,32);
            g.generateTexture('tile_wall', 32, 32);
            
            // –î–µ—Ä–µ–≤–æ
            g.clear();
            g.fillStyle(0x5d4037); g.fillRect(12,20,8,12); // –°—Ç–≤–æ–ª
            g.fillStyle(0x2e7d32); g.fillCircle(16,14,14); // –õ–∏—Å—Ç–≤–∞
            g.fillStyle(0x388e3c); g.fillCircle(12,10,6); // –î–µ—Ç–∞–ª—å –ª–∏—Å—Ç–≤—ã
            g.generateTexture('tree', 32, 32);

            // 2. –ì–ï–ù–ï–†–ê–¶–ò–Ø –ú–ò–†–ê (–ë–µ–∑ Tilemap, –ø—Ä–æ—Å—Ç–æ —Å–ø—Ä–∞–π—Ç—ã –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
            // –†–∏—Å—É–µ–º –∑–µ–º–ª—é
            const bg = this.add.group();
            for(let y=0; y<40; y++) {
                for(let x=0; x<40; x++) {
                    let tex = 'tile_grass';
                    // –ì–æ—Ä–æ–¥ –≤ —Ü–µ–Ω—Ç—Ä–µ (15-25)
                    if(x>15 && x<25 && y>15 && y<25) tex = 'tile_stone';
                    // –°—Ç–µ–Ω–∞ –≤–æ–∫—Ä—É–≥ –≥–æ—Ä–æ–¥–∞
                    if((x===15 || x===25) && y>=15 && y<=25) tex = 'tile_wall';
                    if((y===15 || y===25) && x>=15 && x<=25) tex = 'tile_wall';
                    // –í–æ—Ä–æ—Ç–∞
                    if((x===20 && y===25) || (x===20 && y===15)) tex = 'tile_stone';

                    const tile = this.add.image(x*64, y*64, tex).setScale(2).setOrigin(0);
                    bg.add(tile);
                    
                    // –§–∏–∑–∏–∫–∞ —Å—Ç–µ–Ω (–ø—Ä–æ—Å—Ç–∞—è)
                    if(tex === 'tile_wall') {
                        const wall = this.physics.add.staticImage(x*64 + 32, y*64 + 32, 'tile_wall').setScale(2).setVisible(false);
                        this.physics.add.collider(game.sprites.player, wall); // –î–æ–±–∞–≤–∏–º –ø–æ–∑–∂–µ, —Ç.–∫. –∏–≥—Ä–æ–∫–∞ –µ—â–µ –Ω–µ—Ç
                        wall.setBodySize(64, 64);
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –≥—Ä—É–ø–ø—É, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–ª–∏–∑–∏—é
                        if(!this.walls) this.walls = this.physics.add.staticGroup();
                        this.walls.add(wall);
                    }
                }
            }

            this.physics.world.setBounds(0,0, 40*64, 40*64); // 2560x2560

            // 3. –ò–ì–†–û–ö –ò –û–ë–™–ï–ö–¢–´
            game.sprites.player = this.physics.add.sprite(1600, 1600, 'player').setScale(2);
            game.sprites.player.setCollideWorldBounds(true);
            if(this.walls) this.physics.add.collider(game.sprites.player, this.walls);
            
            this.cameras.main.startFollow(game.sprites.player);
            this.cameras.main.setZoom(1.2); // –ß—É—Ç—å –º–µ–Ω—å—à–µ –∑—É–º, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –±–æ–ª—å—à–µ

            // NPC
            const npcs = [
                {x: 1600, y: 1400, color: 0x00ffff}, 
                {x: 1700, y: 1500, color: 0xff00ff}
            ];
            npcs.forEach(n => {
                const s = this.physics.add.sprite(n.x, n.y, 'npc').setScale(2).setTint(n.color).setImmovable(true);
                this.physics.add.collider(game.sprites.player, s);
            });

            // –ú–æ–±—ã
            for(let i=0; i<15; i++) {
                const x = Phaser.Math.Between(200, 2400);
                const y = Phaser.Math.Between(200, 2400);
                if(Phaser.Math.Distance.Between(x,y,1600,1600) > 400) { // –ù–µ –≤ –≥–æ—Ä–æ–¥–µ
                    const m = this.physics.add.sprite(x, y, 'mob').setScale(2);
                    game.sprites.mobs.push(m);
                }
            }
            
            // –î–µ—Ä–µ–≤—å—è
            const trees = this.physics.add.staticGroup();
            for(let i=0; i<40; i++) {
                const x = Phaser.Math.Between(100, 2500);
                const y = Phaser.Math.Between(100, 2500);
                if(Phaser.Math.Distance.Between(x,y,1600,1600) > 400) {
                    const t = trees.create(x, y, 'tree').setScale(3);
                    t.setDepth(y); // Y-Sort
                    t.setSize(20, 20);
                    t.setOffset(6, 20);
                }
            }
            this.physics.add.collider(game.sprites.player, trees);

            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            this.input.on('pointerdown', (p) => {
                const wp = this.cameras.main.getWorldPoint(p.x, p.y);
                this.physics.moveTo(game.sprites.player, wp.x, wp.y, 220);
                game.target = wp;
            });
        }
        
        update() {
            const p = game.sprites.player;
            if(!p) return;
            p.setDepth(p.y); // Y-Sort
            
            if(game.target && Phaser.Math.Distance.Between(p.x, p.y, game.target.x, game.target.y) < 10) {
                p.body.setVelocity(0); game.target = null;
            }
            
            // –ê–≤—Ç–æ-—Ñ–∞—Ä–º
            if(game.p.autoFarm && !game.target) {
                let t=null, min=400;
                game.sprites.mobs.forEach(m=>{ 
                    const d=Phaser.Math.Distance.Between(p.x,p.y,m.x,m.y); 
                    if(d<min){min=d; t=m;} 
                });
                if(t) this.physics.moveTo(p, t.x, t.y, 220);
            }
        }
    }
</script>
</body>
</html>

