<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pocket L2 • Telegram Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { margin:0; padding:0; background:#000; font-family:'Courier New',monospace; color:#0f0; overflow:hidden; image-rendering:pixelated; }
    #gameContainer { position:relative; width:100vw; height:100vh; }
    #ui { position:absolute; top:5px; right:5px; width:150px; background:rgba(0,20,0,0.9); border:2px solid #0f0; padding:8px; border-radius:5px; z-index:100; font-size:9px; }
    button { width:100%; margin:3px 0; padding:6px; background:#4a4; color:#000; border:1px solid #0f0; font:inherit; font-weight:bold; }
    #log { height:70px; overflow-y:auto; background:rgba(0,0,0,0.6); padding:3px; font-size:8px; }
    #chatInput { position:absolute; bottom:10px; left:10px; right:10px; background:#000; color:#0f0; border:2px solid #0f0; padding:8px; font:inherit; display:none; z-index:200; }
    #minimap { position:absolute; bottom:10px; right:10px; width:70px; height:70px; border:1px solid #0f0; z-index:50; image-rendering:pixelated; }
    #joystick { position:absolute; bottom:20px; left:20px; width:100px; height:100px; background:rgba(0,255,0,0.2); border-radius:50%; z-index:99; }
    #joystick-knob { position:absolute; width:40px; height:40px; background:#0f0; border-radius:50%; top:30px; left:30px; }
  </style>
</head>
<body>
<div id="gameContainer">
  <canvas id="minimap"></canvas>
  <div id="ui">
    <div id="name">Герой</div>
    Ур:<span id="level">1</span> HP:<span id="hp">100</span>/<span id="maxhp">100</span><br>
    Зол:<span id="gold">0</span>
    <button id="autofarm">Фарм</button>
    <button id="pvpBtn">PvP</button>
    <button id="chatBtn">Чат</button>
    <div id="log"></div>
  </div>
  <input type="text" id="chatInput" placeholder="Сообщение..." maxlength="60">
  <div id="joystick"><div id="joystick-knob"></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
<script>
  // ==================== TELEGRAM WEB APP ====================
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();
  const user = tg.initDataUnsafe.user;
  const userId = user?.id || 'guest_' + Date.now();
  const username = user?.username || user?.first_name || 'Герой';

  // ==================== МУЛЬТИПЛЕЕР ====================
  const WS_URL = 'wss://pocket-l2-multiplayer.glitch.me';
  let socket, myId, players = {}, inPvp = false, pvpTargetId = null;

  function log(msg) {
    const el = document.getElementById('log');
    el.innerHTML += `<div>${msg}</div>`;
    el.scrollTop = el.scrollHeight;
    if (el.children.length > 12) el.removeChild(el.children[0]);
  }

  function initMultiplayer() {
    socket = new WebSocket(WS_URL);
    socket.onopen = () => log('Онлайн в мире!');
    socket.onmessage = e => {
      const d = JSON.parse(e.data);
      if (d.type === 'init') { myId = d.yourId; Object.keys(d.players).forEach(id => addPlayer(id, d.players[id])); }
      if (d.type === 'join') { addPlayer(d.id, d.player); log(`${d.player.name} появился`); }
      if (d.type === 'leave') { removePlayer(d.id); }
      if (d.type === 'move') updateRemotePlayer(d);
      if (d.type === 'chat') log(`[${d.name}]: ${d.msg}`);
      if (d.type === 'pvp_challenge' && d.targetId === myId) {
        if (confirm(`${d.challengerName} вызывает тебя на дуэль!`)) acceptPvp(d.challengerId);
      }
      if (d.type === 'pvp_attack' && d.targetId === myId) {
        gameData.hp = Math.max(0, gameData.hp - d.dmg);
        log(`Удар от ${d.attackerName}: -${d.dmg} HP`);
        updateUI();
        if (gameData.hp <= 0) endPvp(false);
      }
    };
  }

  function addPlayer(id, p) {
    if (players[id]) return;
    const color = Phaser.Math.RND.pick([0x00ffff,0xff00ff,0xffff00,0xff8800,0x88ff88]);
    const s = scene.add.rectangle(p.x||200, p.y||200, 12,12, color).setDepth(10);
    const t = scene.add.text(p.x, p.y-12, p.name||'?', {fontSize:'8px', color:'#fff'}).setOrigin(0.5).setDepth(11);
    players[id] = {sprite:s, text:t, name:p.name||'?', level:p.level||1};
  }
  function removePlayer(id) { if (players[id]) { players[id].sprite.destroy(); players[id].text.destroy(); delete players[id]; } }
  function updateRemotePlayer(d) {
    if (!players[d.id] || d.id === myId) return;
    players[d.id].sprite.x = d.x; players[d.id].sprite.y = d.y;
    players[d.id].text.x = d.x; players[d.id].text.y = d.y-12;
    players[d.id].text.setText(`${d.name} [${d.level}]`);
  }
  function sendPos() {
    if (socket?.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({type:'move', x:player.x, y:player.y, name:gameData.name, level:gameData.level}));
    }
  }
  function sendChat(msg) {
    if (socket && msg.trim()) socket.send(JSON.stringify({type:'chat', msg:msg.trim(), name:gameData.name}));
    document.getElementById('chatInput').value = '';
  }
  function challengePvp(id) { socket.send(JSON.stringify({type:'pvp_challenge', targetId:id, challengerName:gameData.name, challengerId:myId})); }
  function acceptPvp(id) { socket.send(JSON.stringify({type:'pvp_accept', challengerId:id})); startPvp(id); }
  function startPvp(target) {
    inPvp = true; pvpTargetId = target;
    pvpInterval = setInterval(() => {
      const dmg = 10 + gameData.level * 3 + Math.floor(Math.random()*15);
      socket.send(JSON.stringify({type:'pvp_attack', targetId:target, dmg, attackerName:gameData.name}));
    }, 1800);
  }
  function endPvp(won) {
    clearInterval(pvpInterval); inPvp = false;
    if (won) { gameData.gold += 100; log('Победа в PvP! +100 золота'); }
    else { gameData.hp = gameData.maxhp; log('Поражение в PvP'); }
    updateUI();
  }

  // ==================== ИГРА ====================
  let game, scene, player, gameData = {name:username, level:1, xp:0, hp:200, maxhp:200, gold:0};
  let farming = false, farmInterval;

  const saved = localStorage.getItem('pocketl2_' + userId);
  if (saved) gameData = JSON.parse(saved);

  function updateUI() {
    document.getElementById('name').innerText = gameData.name.slice(0,10);
    document.getElementById('level').innerText = gameData.level;
    document.getElementById('hp').innerText = gameData.hp;
    document.getElementById('maxhp').innerText = gameData.maxhp;
    document.getElementById('gold').innerText = gameData.gold;
    localStorage.setItem('pocketl2_' + userId, JSON.stringify(gameData));
  }

  function startGame() {
    initMultiplayer();
    const config = {
      type: Phaser.AUTO,
      parent: 'gameContainer',
      width: window.innerWidth,
      height: window.innerHeight,
      scale: {mode: Phaser.Scale.RESIZE, autoCenter: Phaser.Scale.CENTER_BOTH},
      pixelArt: true,
      physics: {default:'arcade'},
      scene: {preload:function(){}, create, update}
    };
    game = new Phaser.Game(config);
    updateUI();
  }

  function create() {
    scene = this;
    // Мир
    const g = this.add.graphics();
    for(let y=0;y<60;y++) for(let x=0;x<60;x++) {
      g.fillStyle((x+y)%7===0?0x006600:0x00aa00);
      g.fillRect(x*16,y*16,16,16);
    }

    player = this.add.rectangle(300,300,12,12,0xff0000).setDepth(20);
    this.physics.add.existing(player);
    this.cameras.main.startFollow(player, true, 0.1, 0.1);
    this.cameras.main.setZoom(2.2);

    this.time.addEvent({delay:100, loop:true, callback:sendPos});

    // UI
    document.getElementById('autofarm').onclick = () => {
      farming = !farming;
      document.getElementById('autofarm').innerText = farming?'Стоп':'Фарм';
      if(farming) farmInterval = setInterval(()=>{
        gameData.gold += 3; gameData.xp += 7;
        if(gameData.xp >= gameData.level*100) { gameData.level++; gameData.maxhp += 40; gameData.hp = gameData.maxhp; log('Уровень повышен!'); }
        updateUI();
      },1000); else clearInterval(farmInterval);
    };
    document.getElementById('pvpBtn').onclick = () => {
      const list = Object.keys(players).filter(id=>id!==myId);
      if(list.length===0) return log('Никого рядом');
      const target = list[0]; // первый попавшийся
      challengePvp(target);
      log('Вызов отправлен!');
    };
    document.getElementById('chatBtn').onclick = () => document.getElementById('chatInput').style.display = 
      document.getElementById('chatInput').style.display==='block'?'none':'block';
    document.getElementById('chatInput').addEventListener('keydown', e=>{ if(e.key==='Enter') sendChat(e.target.value); });

    // Джойстик
    const joy = document.getElementById('joystick');
    const knob = document.getElementById('joystick-knob');
    let dx=0, dy=0;
    this.input.on('pointerdown', p => {
      joy.style.left = (p.x-50)+'px';
      joy.style.bottom = (window.innerHeight-p.y-50)+'px';
    });
    this.input.on('pointermove', p => {
      dx = p.x - (parseInt(joy.style.left)+50);
      dy = (window.innerHeight-p.y) - (parseInt(joy.style.bottom)+50);
      const dist = Math.min(45, Math.hypot(dx,dy));
      const a = Math.atan2(dy,dx);
      knob.style.left = 30 + dist*Math.cos(a) + 'px';
      knob.style.top = 30 + dist*Math.sin(a) + 'px';
    });
    this.input.on('pointerup', () => { knob.style.left='30px'; knob.style.top='30px'; });
  }

  function update() {
    const speed = 180;
    const dx = parseInt(document.getElementById('joystick-knob').style.left||30) - 30;
    const dy = parseInt(document.getElementById('joystick-knob').style.top||30) - 30;
    const len = Math.hypot(dx,dy);
    if(len>5) player.body.setVelocity(dx/len*speed, dy/len*speed);
    else player.body.setVelocity(0,0);

    // Мини-карта
    const c = document.getElementById('minimap').getContext('2d');
    c.clearRect(0,0,70,70);
    c.fillStyle='#004400'; c.fillRect(0,0,70,70);
    c.fillStyle='#ff0000'; c.fillRect(player.x/16*1.16-2, player.y/16*1.16-2,4,4);
  }

  startGame();
</script>
</body>
</html>
