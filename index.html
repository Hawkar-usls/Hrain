<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pocket L2 Idle ‚Äî L2 Core Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Roboto:wght@400;700&display=swap');
    
    body,html{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#0a001f;color:#fff;font-family:'Roboto', system-ui, sans-serif}
    #menu,#game{display:none;flex-direction:column;align-items:center;justify-content:center;height:100%;background:radial-gradient(circle at center,#2a0066,#0a001f)}
    h1{font-size:3.5rem;text-shadow:0 0 30px #ff00ff; font-family: 'Cinzel', serif;}
    button, .skill-btn { cursor: pointer; transition: all 0.3s; }
    
    /* UI & Stats */
    #stats{position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.75);padding:12px 16px;border-radius:12px;z-index:10;font-size:14px; border: 1px solid #4a0072;}
    .bar{width:180px;height:14px;background:#222;border:1px solid #555;border-radius:7px;overflow:hidden;margin:4px 0}
    .fill{height:100%;transition:width .3s}
    
    /* Soulshot Toggle */
    #ss-toggle {
        width: 40px; height: 40px; border-radius: 8px; border: 2px solid #aaa;
        font-size: 16px; font-weight: bold; background: #333; color: #777;
        display: flex; align-items: center; justify-content: center; margin-top: 5px;
    }
    #ss-toggle.active { background: #ffc800; color: #000; border-color: #fff; box-shadow: 0 0 20px #ffc800; }

    /* Skill Bar (L2 Style) */
    #skills{
        position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
        display:flex; gap: 4px; z-index:10;
        background: rgba(0,0,0,0.6); padding: 8px; border-radius: 12px; border: 1px solid #555;
    }
    .skill-btn{
        width:52px; height:52px; border-radius: 8px; border: 2px solid #777;
        font-size:24px; display:flex; align-items:center; justify-content:center;
        position:relative; background: #111;
    }
    .skill-btn.cd{opacity:0.4;pointer-events:none; filter: grayscale(100%);}
    .skill-btn:hover{transform:scale(1.05); border-color: #fff;}
    
    /* Skill Tooltip */
    #skill-info{position:absolute;bottom:100px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.9);padding:12px;border-radius:8px;width:280px;font-size:13px;display:none;z-index:20;border:1px solid #fff}
    #skill-info.show{display:block;animation:fadeIn 0.2s}
    
    /* Inventory Modal */
    #inventory-modal {
        position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:20;
        display:none; flex-direction:column; align-items:center; padding-top:50px;
    }
    .item-slot{
        width:70px; height:70px; background:#1a1a1a; border:2px solid #555;
        border-radius:8px; margin:5px; display:inline-flex; flex-direction: column;
        align-items:center; justify-content:center; font-size:12px;
    }
    .item-slot .icon { font-size: 24px; }
    .item-slot .count { margin-top: 5px; font-size: 14px; color: #ffd700; }

    /* Particles & Effects */
    #particles{position:absolute;inset:0;pointer-events:none}
    
    /* Game Over */
    #gameOverScreen {
        position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.95);
        display: none; flex-direction: column; align-items: center; justify-content: center;
        z-index: 1000;
    }
    
    /* Animations */
    @keyframes fadeIn{from{opacity:0;transform:translate(-50%, 10px)}to{opacity:1;transform:translate(-50%, 0)}}
    @keyframes p{to{transform:translate(-50%,-50%) translateY(-120px);opacity:0}}
    @keyframes lvl{0%,100%{transform:scale(1)}50%{transform:scale(2.2);text-shadow:0 0 60px gold}}
    @keyframes heal{0%{transform:scale(1);background:#00ff88}50%{transform:scale(1.5)}100%{transform:scale(1);opacity:0}}
    @keyframes aoe{0%{transform:scale(0);opacity:1}100%{transform:scale(3);opacity:0}}
    @keyframes buff{0%,100%{opacity:1} 50%{opacity:0.5}}
    @keyframes shake {
        0% { transform: translate(1px, 1px) rotate(0deg); }
        10% { transform: translate(-1px, -2px) rotate(-1deg); }
        20% { transform: translate(-3px, 0px) rotate(1deg); }
        30% { transform: translate(3px, 2px) rotate(0deg); }
        100% { transform: translate(1px, -1px) rotate(0deg); }
    }
</style>
</head>
<body>

<div id="menu" class="flex">
    <div class="text-center">
        <h1 class="animate-pulse">Pocket L2</h1>
        <input id="name" placeholder="–ò–º—è" class="p-3 mt-4 text-black rounded text-lg">
        <select id="cls" class="p-3 mt-3 text-black rounded text-lg">
            <option value="gladiator">Gladiator ‚öîÔ∏è</option>
            <option value="sorcerer">Sorcerer üîÆ</option>
            <option value="hawkeye">Hawkeye üèπ</option>
        </select>
        <button onclick="start()" class="mt-6 px-12 py-4 bg-gradient-to-r from-purple-600 to-pink-600 rounded-xl text-2xl hover:scale-105 transition">–ò–≥—Ä–∞—Ç—å</button>
    </div>
</div>

<div id="game" class="relative">
    <div id="stats">
        <div id="pname" class="font-bold text-yellow-300"></div>
        <div class="bar"><div id="hp" class="fill bg-red-600 w-full"></div></div>
        <div class="bar"><div id="mp" class="fill bg-blue-600 w-full"></div></div>
        <div class="bar"><div id="xp" class="fill bg-green-500" style="width:0%"></div></div>
        <div>–£—Ä <span id="lvl">1</span> ‚Ä¢ EXP <span id="exp">0</span>/<span id="need">100</span></div>
        <div>–ê–¥–µ–Ω–∞ <span id="adena" class="text-yellow-400 font-bold">0</span></div>
        <div class="flex gap-2 items-center">
            <div id="ss-toggle" onclick="toggleSS()">SS</div>
            <div class="text-sm">–ó–∞—Ä—è–¥—ã: <span id="ss-count">0</span></div>
        </div>
        <button onclick="toggleInventory()" class="mt-2 px-3 py-1 bg-gray-600 rounded text-xs">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
        <button onclick="buySS(100)" class="mt-1 px-3 py-1 bg-yellow-600 rounded text-xs text-black">–ö—É–ø–∏—Ç—å SS (100–ê)</button>
    </div>
    <svg id="c"></svg>
    <div id="particles"></div>
    <div id="skills">
        <div class="skill-btn" id="skill1" data-skill="1"></div>
        <div class="skill-btn" id="skill2" data-skill="2"></div>
        <div class="skill-btn" id="skill3" data-skill="3"></div>
    </div>
    <div id="skill-info">
        <div id="skill-name" class="font-bold text-lg mb-1"></div>
        <div id="skill-desc" class="text-sm opacity-90"></div>
        <div id="skill-stats" class="text-xs mt-1 opacity-75"></div>
    </div>
    
    <div id="inventory-modal">
        <h2 class="text-3xl mb-6 font-cinzel">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
        <div id="inventory-grid" class="w-full max-w-lg p-4 grid grid-cols-5 gap-2">
            </div>
        <button onclick="toggleInventory()" class="mt-8 px-8 py-4 bg-red-600 rounded text-xl">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    
    <div id="gameOverScreen" class="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-content: center flex-col text-white hidden z-50">
        <h1 class="text-6xl font-bold mb-8 text-red-500 animate-pulse font-cinzel">–ü–û–†–ê–ñ–ï–ù–ò–ï</h1>
        <button onclick="location.reload()" class="px-10 py-5 bg-red-600 hover:bg-red-700 text-3xl rounded-xl shadow-2xl transform hover:scale-105 transition">
            –ó–∞–Ω–æ–≤–æ
        </button>
    </div>
</div>

<audio id="sfx-adena" src="https://cdn.freesound.org/previews/657/657370_5674468-lq.mp3" preload="auto"></audio>
<audio id="sfx-hit" src="https://cdn.freesound.org/previews/612/612552_5674468-lq.mp3" preload="auto"></audio>
<audio id="sfx-buff" src="https://cdn.freesound.org/previews/276/276792_5123851-lq.mp3" preload="auto"></audio>
<audio id="sfx-lvl" src="https://cdn.freesound.org/previews/276/276285_5123851-lq.mp3" preload="auto"></audio>

<script>
// === L2-STYLE CLASS CONFIG ===

const AGGRO_RANGE = 150; // Distance for mobs to aggro
const PULL_RANGE = 300; // Distance for player to auto-attack

const CLASS_STATS = {
    gladiator: { hp: 180, mp: 60, atk: 14, speed: 2.8, color: '#ef4444' },
    sorcerer:  { hp: 90,  mp: 120, atk: 10, speed: 3.2, color: '#8b5cf6' },
    hawkeye:   { hp: 130, mp: 80, atk: 12, speed: 3.5, color: '#10b981' }
};

const CLASS_SKILLS = {
    gladiator: [
        {name: 'Triple Slash', icon: '‚öîÔ∏è', desc: '–ë—ã—Å—Ç—Ä–∞—è —Ç—Ä–æ–π–Ω–∞—è –∞—Ç–∞–∫–∞ –ø–æ –æ–¥–Ω–æ–π —Ü–µ–ª–∏.', dmg: 3.0, mp: 15, cd: 3000, aoe: false, color: '#ff4444'},
        {name: 'Sonic Blaster', icon: 'üî•', desc: '–î–∞–ª—å–Ω–æ–±–æ–π–Ω—ã–π –∑–≤—É–∫–æ–≤–æ–π —É–¥–∞—Ä –ø–æ –æ–±–ª–∞—Å—Ç–∏.', dmg: 2.5, mp: 25, cd: 5000, aoe: true, color: '#ff8800'},
        {name: 'Lionheart', icon: 'üõ°', desc: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ú–∞–∫—Å. HP –∏ –∑–∞—â–∏—Ç—É –Ω–∞ 15 —Å–µ–∫—É–Ω–¥.', buff: {stat: 'hp', mult: 1.3, duration: 15000}, mp: 20, cd: 30000, color: '#44ff44'}
    ],
    sorcerer: [
        {name: 'Prominence', icon: 'üî•', desc: '–ú–æ—â–Ω—ã–π –æ–≥–Ω–µ–Ω–Ω—ã–π —É–¥–∞—Ä –ø–æ —Ü–µ–ª–∏.', dmg: 4.0, mp: 20, cd: 3500, aoe: false, color: '#ff4444'},
        {name: 'Tempest', icon: '‚ùÑÔ∏è', desc: 'AOE-–≤–∏—Ö—Ä—å, –Ω–∞–Ω–æ—Å—è—â–∏–π —É—Ä–æ–Ω –≤—Å–µ–º –≤–æ–∫—Ä—É–≥.', dmg: 3.0, mp: 30, cd: 6000, aoe: true, color: '#4444ff'},
        {name: 'Empower', icon: '‚≠ê', desc: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–∞–≥–∏—á–µ—Å–∫—É—é –∞—Ç–∞–∫—É –Ω–∞ 15 —Å–µ–∫—É–Ω–¥.', buff: {stat: 'atk', mult: 1.5, duration: 15000}, mp: 25, cd: 30000, color: '#ffee44'}
    ],
    hawkeye: [
        {name: 'Double Shot', icon: 'üèπ', desc: '–î–≤–æ–π–Ω–æ–π –≤—ã—Å—Ç—Ä–µ–ª —Å –≤—ã—Å–æ–∫–∏–º —à–∞–Ω—Å–æ–º –∫—Ä–∏—Ç–∞.', dmg: 3.5, mp: 12, cd: 2500, aoe: false, color: '#ff4444'},
        {name: 'Arrow Rain', icon: 'üí•', desc: '–ó–∞–ª–ø —Å—Ç—Ä–µ–ª –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏.', dmg: 2.8, mp: 22, cd: 5000, aoe: true, color: '#ff8800'},
        {name: 'Snipe', icon: 'üëÅÔ∏è', desc: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ñ–∏–∑. –∞—Ç–∞–∫—É –∏ –¥–∞–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 15 —Å–µ–∫—É–Ω–¥.', buff: {stat: 'atk', mult: 1.4, duration: 15000}, mp: 18, cd: 30000, color: '#44ff44'}
    ]
};

// === GLOBALS ===
let p, svg, w, h, mobs = [], pool = [], cooldowns = {}, currentSkills = [];
let isGameOver = false;

// === UTILS ===
function play(soundId) { 
    const sound = document.getElementById(soundId);
    if (sound) {
        sound.currentTime = 0; 
        sound.play().catch(() => {}); 
    }
}
function getDistance(n1, n2) {
    return Math.hypot(n1.x - n2.x, n1.y - n2.y);
}

// === GAME START ===
function start() {
    const cls = document.getElementById('cls').value;
    const stats = CLASS_STATS[cls];
    
    p = {
        name: document.getElementById('name').value || '–ì–µ—Ä–æ–π',
        cls, 
        color: stats.color,
        x: innerWidth/2, y: innerHeight/2,
        maxHp: stats.hp, hp: stats.hp,
        maxMp: stats.mp, mp: stats.mp,
        baseAtk: stats.atk, atk: stats.atk, // Base and current attack
        speed: stats.speed,
        level: 1, exp: 0, adena: 0,
        inventory: {'–û–±–ª–æ–º–æ–∫ –ö–æ—Å—Ç–∏': 5}, // Starting inventory
        buffs: {}, // {stat: 'hp', mult: 1.3, duration: 15000}
        soulshots: 0, ssActive: false,
    };
    
    currentSkills = CLASS_SKILLS[cls];
    
    document.getElementById('pname').textContent = p.name + ' [' + cls.toUpperCase() + ']';
    document.getElementById('menu').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    
    init();
}

// === INITIALIZATION ===
function init() {
    w = innerWidth; h = innerHeight;
    svg = d3.select('#c').attr('width', w).attr('height', h);
    svg.append('rect').attr('width', w).attr('height', h).attr('fill', '#0f001f');

    // Player
    const pg = svg.append('g').attr('class', 'player');
    pg.append('circle').attr('r', 20).attr('fill', p.color).attr('stroke', '#fff').attr('stroke-width', 4);
    pg.append('text').attr('y', 45).attr('text-anchor', 'middle').attr('fill', '#fff').text(p.name);
    pg.attr('transform', `translate(${p.x},${p.y})`);

    // Click to move
    svg.on('click', e => {
        if (isGameOver) return;
        const [x,y] = d3.pointer(e);
        p.x = x; p.y = y;
        d3.select('.player').transition().duration(400).attr('transform', `translate(${x},${y})`);
    });

    // Skills + Tooltips
    document.querySelectorAll('.skill-btn').forEach((btn, i) => {
        const skill = currentSkills[i];
        btn.textContent = skill.icon;
        btn.style.background = skill.color;
        btn.onclick = () => useSkill(i+1);
        btn.onmouseenter = () => showSkillInfo(i+1);
        btn.onmouseleave = () => hideSkillInfo();
    });

    for(let i=0;i<10;i++) spawnMob(); // More mobs
    updateUI();
    requestAnimationFrame(loop);
}

// === SKILL TOOLTIPS ===
function showSkillInfo(id) {
    const skill = currentSkills[id-1];
    document.getElementById('skill-name').textContent = skill.name;
    document.getElementById('skill-desc').textContent = skill.desc;
    let stats = `–ú–∞–Ω–∞: ${skill.mp} | –ö–î: ${skill.cd/1000}s`;
    if (skill.dmg) stats += ` | –£—Ä–æ–Ω: ${skill.dmg}x`;
    if (skill.buff) stats += ` | –î–ª–∏—Ç: ${skill.buff.duration/1000}s`;
    document.getElementById('skill-stats').innerHTML = stats;
    document.getElementById('skill-info').classList.add('show');
}
function hideSkillInfo() { document.getElementById('skill-info').classList.remove('show'); }

// === SOULSHOTS (SS) ===
function toggleSS() {
    p.ssActive = !p.ssActive;
    document.getElementById('ss-toggle').classList.toggle('active', p.ssActive);
    if (p.ssActive && p.soulshots <= 0) {
        p.ssActive = false;
        document.getElementById('ss-toggle').classList.remove('active');
    }
}
function buySS(cost) {
    if (p.adena >= cost) {
        p.adena -= cost;
        p.soulshots += 200;
        updateUI();
    }
}

// === INVENTORY ===
function toggleInventory() {
    const modal = document.getElementById('inventory-modal');
    if (modal.style.display === 'flex') {
        modal.style.display = 'none';
    } else {
        modal.style.display = 'flex';
        renderInventory();
    }
}
function renderInventory() {
    const grid = document.getElementById('inventory-grid');
    grid.innerHTML = '';
    for (const [itemName, count] of Object.entries(p.inventory)) {
        let icon = '‚ùì';
        if (itemName.includes('–ö–æ—Å—Ç–∏')) icon = 'ü¶¥';
        if (itemName.includes('–ù–∏—Ç—å')) icon = 'üßµ';
        
        grid.innerHTML += `
            <div class="item-slot">
                <div class="icon">${icon}</div>
                <div>${itemName}</div>
                <div class="count">${count}</div>
            </div>
        `;
    }
}

// === SKILL USAGE ===
function useSkill(id) {
    if (isGameOver) return;
    const skill = currentSkills[id-1];
    if (p.mp < skill.mp || cooldowns[id]) return;
    
    p.mp -= skill.mp;
    cooldowns[id] = skill.cd;
    document.getElementById('skill'+id).classList.add('cd');
    
    // Effects
    if (skill.buff) { // Buff
        play('sfx-buff');
        applyBuff(skill.buff);
        createEffect(p.x, p.y, 'heal'); // Visual effect for buff
    } else {
        // Attack
        play('sfx-hit');
        let baseDmg = (p.atk + p.level * 2) * skill.dmg;
        
        // L2: Soulshots are consumed by skills!
        if (p.ssActive && p.soulshots > 0) {
            baseDmg *= (p.cls === 'sorcerer' ? 2.5 : 2.0); // Mages get bigger bonus
            p.soulshots--;
            updateUI(); // Update SS count immediately
        }
        
        mobs.forEach(m => {
            const dist = getDistance(m, p);
            if (dist < (skill.aoe ? 280 : 200)) {
                m.hp -= baseDmg;
                m.aggro = true; // Attacking aggros the mob
                createParticles(m.x, m.y, skill.color || p.color);
                if (skill.aoe) createEffect(m.x, m.y, 'aoe');
            }
        });
    }
    
    setTimeout(() => {
        cooldowns[id] = 0;
        document.getElementById('skill'+id).classList.remove('cd');
    }, skill.cd);
}

// === BUFF SYSTEM ===
function applyBuff(buff) {
    // Clear old buff timer if it exists
    if (p.buffs[buff.stat]) {
        clearTimeout(p.buffs[buff.stat].timer);
    }
    
    p.buffs[buff.stat] = {
        mult: buff.mult,
        timer: setTimeout(() => {
            delete p.buffs[buff.stat];
            recalculateStats();
        }, buff.duration)
    };
    recalculateStats();
}

function recalculateStats() {
    // Reset to base
    p.atk = p.baseAtk;
    p.maxHp = CLASS_STATS[p.cls].hp + (p.level * 35); // Apply level bonus
    
    // Apply buffs
    if (p.buffs['atk']) p.atk *= p.buffs['atk'].mult;
    if (p.buffs['hp']) p.maxHp *= p.buffs['hp'].mult;
    
    p.atk = Math.round(p.atk);
    p.maxHp = Math.round(p.maxHp);
    if (p.hp > p.maxHp) p.hp = p.maxHp; // Clamp HP, don't heal
}


// === MOB SPAWNING ===
function spawnMob() {
    let g = pool.length ? pool.pop() : svg.append('g').attr('class', 'mob-node');
    const a = Math.random()*Math.PI*2;
    const d = 300 + Math.random()*400;
    const x = p.x + Math.cos(a)*d; // Spawn around player
    const y = p.y + Math.sin(a)*d;
    
    g.attr('transform', `translate(${x},${y})`).style('display', '');
    
    if (!g.select('circle').node()) {
        g.append('circle').attr('class', 'mob-body').attr('r', 16).attr('fill', '#555') // Passive color
            .attr('stroke', '#888').attr('stroke-width', 3);
        // HP Bar
        g.append('rect').attr('class', 'hp-bg').attr('width', 30).attr('height', 4).attr('x', -15).attr('y', -25).attr('fill', '#333');
        g.append('rect').attr('class', 'hp-fill').attr('width', 30).attr('height', 4).attr('x', -15).attr('y', -25).attr('fill', '#ef4444');
    }
    
    const mobData = {
        g, x, y, 
        maxHp: 60 + p.level*18, hp: 60 + p.level*18,
        atk: 5 + p.level * 2,
        speed: 1.5 + p.level * 0.05,
        lastAttackTime: 0,
        aggro: false // L2: Mob is passive
    };
    g.datum(mobData); // Bind data to D3 node
    mobs.push(mobData);
}

// === EFFECTS ===
function createEffect(x, y, type) {
    const div = document.createElement('div');
    div.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:50px;height:50px;pointer-events:none;border-radius:50%;transform:translate(-50%,-50%);`;
    if (type == 'heal') {
        div.style.background = '#00ff88';
        div.style.animation = 'heal 1.2s forwards';
    } else {
        div.style.background = 'radial-gradient(circle, #ff00ff, transparent)';
        div.style.animation = 'aoe 0.9s forwards';
    }
    document.getElementById('particles').appendChild(div);
    setTimeout(() => div.remove(), 1200);
}

// === PARTICLES ===
const particlePool = [];
function createParticles(x, y, color = "#fff", count = 12) {
    for(let i = 0; i < count; i++) {
        let el = particlePool.length ? particlePool.pop() : document.createElement('div');
        el.style.cssText = `position:absolute;left:${x}px;top:${y}px;width:5px;height:5px;background:${color};border-radius:50%;transform:translate(-50%,-50%);animation:p 0.7s forwards`;
        document.getElementById('particles').appendChild(el);
        setTimeout(() => { el.remove(); particlePool.push(el); }, 700);
    }
}

// === Game Over ===
function gameOver() {
    if (isGameOver) return;
    isGameOver = true;
    document.getElementById('gameOverScreen').style.display = 'flex';
    play('sfx-lvl'); // Death sound
}

// === MAIN LOOP ===
let last = 0;
function loop(t) {
    if (isGameOver) return;
    
    const delta = (t - last) || 16.67;
    last = t;

    // Regen
    p.mp = Math.min(p.maxMp, p.mp + (p.maxMp * 0.002 * (delta/16.67)));
    p.hp = Math.min(p.maxHp, p.hp + (p.maxHp * 0.001 * (delta/16.67)));
    if (p.hp <= 0) { gameOver(); return; }

    // Mob Logic (Movement, Aggro, Attack)
    for(let i=mobs.length-1;i>=0;i--) {
        const m = mobs[i];
        const dist = getDistance(m, p);
        
        // 1. Check Aggro
        if (!m.aggro && dist < AGGRO_RANGE) {
            m.aggro = true;
        }
        
        // If mob is not aggroed, do nothing
        if (!m.aggro) {
             m.g.select('.mob-body').attr('fill', '#555'); // Passive color
             continue;
        }
        
        m.g.select('.mob-body').attr('fill', '#7f1d1d'); // Active color

        // 2. Movement (if aggroed)
        if (dist > 40) { 
            const dx = p.x - m.x;
            const dy = p.y - m.y;
            m.x += (dx / dist) * m.speed * (delta/16.67);
            m.y += (dy / dist) * m.speed * (delta/16.67);
            m.g.attr('transform', `translate(${m.x},${m.y})`);
        } else { 
        // 3. Attack (if in melee range)
            if (t - m.lastAttackTime > 2000) { // 2 sec attack CD
                p.hp -= m.atk;
                m.lastAttackTime = t;
                play('sfx-hit');
                document.body.style.animation = 'shake 0.3s';
                setTimeout(()=>document.body.style.animation='', 300);
            }
        }
        
        // 4. Auto-farm (Player attacking mob)
        if (dist < PULL_RANGE) { // Attack aggroed mobs within PULL_RANGE
            let damage = p.atk * 0.005 * delta; // DpS
            
            // L2: Auto-attack consumes SS!
            if (p.ssActive && p.soulshots > 0 && t % 1000 < delta) { // Chance to consume SS once per sec
                damage *= 2.0; 
                p.soulshots--;
                updateUI(); // Update SS count immediately
            }
            
            m.hp -= damage; 
            if (t % 500 < delta) { 
                 createParticles(m.x, m.Y, p.color, 4);
            }
            
            // Update mob HP bar
            m.g.select('.hp-fill').attr('width', Math.max(0, (m.hp / m.maxHp) * 30));

            // 5. Mob Death
            if (m.hp <= 0) {
                p.adena += 9 + Math.floor(Math.random()*13);
                p.exp += 13 + p.level * 2;
                
                // L2: Resource Drop
                if (Math.random() < 0.3) { // 30% drop chance
                    const res = '–û–±–ª–æ–º–æ–∫ –ö–æ—Å—Ç–∏';
                    p.inventory[res] = (p.inventory[res] || 0) + 1;
                }
                
                createParticles(m.x, m.y, '#ffd700', 16);
                play('sfx-adena');
                
                m.g.style('display', 'none');
                pool.push(m.g);
                mobs.splice(i,1);
                
                checkLevel();
                if (mobs.length < 9) spawnMob(); // Maintain 10 mobs
            }
        }
    }

    // UI
    updateUI();

    // Cooldowns
    Object.keys(cooldowns).forEach(k => cooldowns[k] > delta && (cooldowns[k] -= delta));

    requestAnimationFrame(loop);
}

// === LEVEL UP ===
function checkLevel() {
    const expNeeded = p.level*100;
    if (p.exp >= expNeeded) {
        p.level++;
        p.exp -= expNeeded; // Carry over remaining exp
        p.maxHp += 35; p.hp = p.maxHp;
        p.maxMp += 25; p.mp = p.maxMp;
        p.baseAtk += 4; // Increase base attack
        recalculateStats(); // Recalculate stats considering buffs
        
        play('sfx-lvl');
        const msg = document.createElement('div');
        msg.textContent = `–£–†–û–í–ï–ù–¨ ${p.level}!`;
        msg.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:5rem;color:gold;animation:lvl 2.5s forwards;z-index:100;pointer-events:none;font-weight:bold;text-shadow:0 0 20px #ffd700; font-family: "Cinzel", serif;';
        document.body.appendChild(msg);
        setTimeout(()=>msg.remove(),2500);
    }
}

function updateUI() {
    document.getElementById('hp').style.width = (p.hp/p.maxHp*100)+'%';
    document.getElementById('mp').style.width = (p.mp/p.maxMp*100)+'%';
    document.getElementById('xp').style.width = (p.exp/(p.level*100)*100)+'%';
    document.getElementById('lvl').textContent = p.level;
    document.getElementById('exp').textContent = p.exp;
    document.getElementById('need').textContent = p.level*100;
    document.getElementById('adena').textContent = p.adena;
    document.getElementById('ss-count').textContent = p.soulshots;
    
    // Check SS
    if (p.soulshots <= 0 && p.ssActive) {
        p.ssActive = false;
        document.getElementById('ss-toggle').classList.remove('active');
    }
}

// === ANIMATIONS ===
const style = document.createElement("style");
style.textContent = `@keyframes p{to{transform:translate(-50%,-50%) translateY(-120px);opacity:0}} @keyframes lvl{0%,100%{transform:scale(1)}50%{transform:scale(2.2);text-shadow:0 0 60px gold}} @keyframes heal{0%{transform:scale(1)}50%{transform:scale(1.8);box-shadow:0 0 30px #00ff88}100%{transform:scale(1);opacity:0}} @keyframes aoe{0%{transform:scale(0);opacity:1}100%{transform:scale(3.5);opacity:0}} @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}} @keyframes shake{0%{transform:translate(1px, 1px) rotate(0deg)} 10%{transform:translate(-1px, -2px) rotate(-1deg)} 20%{transform:translate(-3px, 0px) rotate(1deg)} 30%{transform:translate(3px, 2px) rotate(0deg)} 100%{transform:translate(1px, -1px) rotate(0deg)}}`;
document.head.appendChild(style);

// === START ===
document.getElementById('menu').style.display='flex';
</script>
</body>
</html>
