<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>HRAIN v2.4 (One Button)</title>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #f4f7f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;
            overscroll-behavior: none;
        }
        
        #logo {
            position: absolute; top: 50px; left: 20px;
            font-size: 1.5rem; font-weight: 800; color: #333;
            pointer-events: none; z-index: 10; opacity: 0.8;
        }

        /* === –£–ú–ù–ê–Ø –ö–ù–û–ü–ö–ê === */
        #main-btn {
            position: absolute;
            bottom: 40px; left: 50%;
            transform: translateX(-50%);
            width: 70px; height: 70px;
            border-radius: 50%; border: none;
            font-size: 32px; color: white;
            z-index: 100; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            -webkit-tap-highlight-color: transparent;
            /* –ó–∞–ø—Ä–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏—è —á—Ç–æ–±—ã long-press —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ */
            user-select: none; 
        }

        /* –°–æ—Å—Ç–æ—è–Ω–∏–µ 1: –î–æ–±–∞–≤–∏—Ç—å (–°–∏–Ω–∏–π/–§–∏–æ–ª–µ—Ç–æ–≤—ã–π) */
        #main-btn.mode-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* –°–æ—Å—Ç–æ—è–Ω–∏–µ 2: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–û—Ä–∞–Ω–∂–µ–≤—ã–π) */
        #main-btn.mode-edit {
            background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%);
            box-shadow: 0 10px 25px rgba(255, 94, 98, 0.4);
            transform: translateX(-50%) rotate(360deg); /* –ö—Ä—É—Ç–æ–π —ç—Ñ—Ñ–µ–∫—Ç –ø–æ–≤–æ—Ä–æ—Ç–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ */
        }

        /* –°–æ—Å—Ç–æ—è–Ω–∏–µ 3: –£–¥–∞–ª–µ–Ω–∏–µ (–ö—Ä–∞—Å–Ω—ã–π –ø—Ä–∏ —É–¥–µ—Ä–∂–∞–Ω–∏–∏) */
        #main-btn.holding-delete {
            background: #dc2626;
            transform: translateX(-50%) scale(1.2);
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.6);
        }

        /* –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ */
        #reset-btn {
            position: absolute; top: 55px; right: 20px;
            font-size: 0.8rem; color: #888; background: rgba(255,255,255,0.5); 
            border: 1px solid #ccc; padding: 6px 12px; border-radius: 20px;
            z-index: 10; cursor: pointer; backdrop-filter: blur(5px);
        }

        #chart { width: 100%; height: 100%; touch-action: none; }
        
        line.link { stroke: #b0b8c0; stroke-width: 2px; opacity: 0.6; }
        
        circle.node {
            fill: #ffffff; stroke: #333; stroke-width: 2px;
            transition: fill 0.2s, stroke 0.2s;
        }
        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É–∑–ª–∞ */
        circle.node.selected { 
            fill: #fff3e0; 
            stroke: #ff5e62; /* –¶–≤–µ—Ç –ø–æ–¥ –∫–∞—Ä–∞–Ω–¥–∞—à */
            stroke-width: 4px; 
        }
        
        text.label {
            font-size: 14px; fill: #222; pointer-events: none;
            text-anchor: middle; font-weight: 600;
            paint-order: stroke; stroke: #f4f7f6; stroke-width: 3px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); z-index: 2000; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white; width: 280px; border-radius: 24px; padding: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); text-align: center;
        }
        #rename-input {
            font-size: 1.2rem; padding: 12px; margin-bottom: 15px;
            border: 2px solid #e4e4e7; border-radius: 12px;
            text-align: center; width: 100%; box-sizing: border-box; outline: none;
        }
        #rename-input:focus { border-color: #ff9966; }
        
        .modal-btn {
            padding: 12px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 600; cursor: pointer; width: 100%; margin-top: 5px;
        }
        .btn-save { background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%); color: white; }
        .btn-cancel { background: #f4f4f5; color: #71717a; }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —É–¥–∞–ª–µ–Ω–∏—è (—Ç–µ–∫—Å—Ç –Ω–∞–¥ –∫–Ω–æ–ø–∫–æ–π) */
        #delete-hint {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 8px 16px;
            border-radius: 20px; font-size: 0.9rem; pointer-events: none;
            opacity: 0; transition: opacity 0.2s;
        }
        #delete-hint.visible { opacity: 1; }

    </style>
</head>
<body>

    <div id="logo">üß† HRAIN</div>
    <button id="reset-btn" onclick="clearAllData()">–°–±—Ä–æ—Å</button>
    
    <div id="delete-hint">–£–¥–µ—Ä–∂–∏–≤–∞–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è</div>

    <button id="main-btn" class="mode-add">+</button>

    <div id="rename-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 style="margin-top:0; color:#333;">–ù–æ–≤–æ–µ –∏–º—è</h3>
            <input type="text" id="rename-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
            <button class="modal-btn btn-save" onclick="saveRename()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="modal-btn btn-cancel" onclick="closeRename()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="chart"></div>

<script>
    // === 0. –î–ê–ù–ù–´–ï ===
    function loadData() {
        const saved = localStorage.getItem('hrain_d3_v3');
        if (saved) { try { return JSON.parse(saved); } catch (e) { return null; } }
        return null;
    }
    const initialData = loadData() || {
        nodes: [ { id: 1, label: "Mind", x: window.innerWidth/2, y: window.innerHeight/2 } ],
        links: []
    };
    let nodes = initialData.nodes;
    let links = initialData.links;

    // === 1. D3 SETUP ===
    const width = window.innerWidth;
    const height = window.innerHeight;
    let selectedNode = null; // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —É–∑–µ–ª
    
    const svg = d3.select("#chart").append("svg")
        .attr("width", width).attr("height", height)
        .attr("viewBox", [0, 0, width, height]);

    const g = svg.append("g");
    const linkGroup = g.append("g").attr("class", "links");
    const nodeGroup = g.append("g").attr("class", "nodes");
    const textGroup = g.append("g").attr("class", "texts");

    // –ö–ª–∏–∫ –ø–æ —Ñ–æ–Ω—É —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏–µ
    const zoom = d3.zoom().scaleExtent([0.2, 5]).on("zoom", (event) => g.attr("transform", event.transform));
    
    svg.call(zoom)
       .on("dblclick.zoom", null)
       .on("click", (event) => {
           if (event.target.tagName === 'svg') {
               deselectNode();
           }
       });

    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(130))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("collide", d3.forceCollide().radius(d => (d.radius || 30) + 10).iterations(2));

    // === 2. –£–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–û–ô (–ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê) ===
    const mainBtn = document.getElementById('main-btn');
    const deleteHint = document.getElementById('delete-hint');
    let pressTimer;
    let isLongPress = false;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É
    function handleBtnDown(e) {
        if (selectedNode) {
            // –ï—Å–ª–∏ —É–∑–µ–ª –≤—ã–±—Ä–∞–Ω -> –†–µ–∂–∏–º –ö–ê–†–ê–ù–î–ê–®
            e.preventDefault(); // –ß—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –∫–ª–∏–∫ —Å—Ä–∞–∑—É
            isLongPress = false;
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —É–¥–∞–ª–µ–Ω–∏—è
            mainBtn.classList.add('holding-delete'); // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–∫—Ä–∞—Å–Ω–µ–Ω–∏—è
            deleteHint.classList.add('visible');
            
            pressTimer = setTimeout(() => {
                isLongPress = true;
                deleteSelectedNode();
                if (navigator.vibrate) navigator.vibrate(100);
            }, 800); // 0.8 —Å–µ–∫ —É–¥–µ—Ä–∂–∞–Ω–∏–µ = —É–¥–∞–ª–µ–Ω–∏–µ
        } else {
            // –ï—Å–ª–∏ —É–∑–µ–ª –Ω–µ –≤—ã–±—Ä–∞–Ω -> –†–µ–∂–∏–º –ü–õ–Æ–°
            mainBtn.style.transform = "translateX(-50%) scale(0.9)";
        }
    }

    function handleBtnUp(e) {
        // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
        clearTimeout(pressTimer);
        mainBtn.classList.remove('holding-delete');
        deleteHint.classList.remove('visible');
        mainBtn.style.transform = "";

        if (selectedNode) {
            // –õ–æ–≥–∏–∫–∞ –ö–∞—Ä–∞–Ω–¥–∞—à–∞
            if (!isLongPress) {
                // –ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∂–∞—Ç–∏–µ -> –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
                openRename();
            }
        } else {
            // –õ–æ–≥–∏–∫–∞ –ü–ª—é—Å–∞
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–¥—É —Å –º–∏–∫—Ä–æ-–∑–∞–¥–µ—Ä–∂–∫–æ–π
            setTimeout(createNewNode, 100);
        }
        isLongPress = false;
    }

    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ Touch –∏ Mouse)
    mainBtn.addEventListener('mousedown', handleBtnDown);
    mainBtn.addEventListener('touchstart', handleBtnDown, {passive: false});
    
    mainBtn.addEventListener('mouseup', handleBtnUp);
    mainBtn.addEventListener('touchend', (e) => {
        e.preventDefault(); // –í–∞–∂–Ω–æ –¥–ª—è iOS
        handleBtnUp(e);
    });

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∞ –∫–Ω–æ–ø–∫–∏
    function updateButtonState() {
        if (selectedNode) {
            mainBtn.textContent = "‚úé";
            mainBtn.className = "mode-edit";
        } else {
            mainBtn.textContent = "+";
            mainBtn.className = "mode-add";
        }
    }

    // === 3. –§–£–ù–ö–¶–ò–ò –î–ï–ô–°–¢–í–ò–ô ===

    function deselectNode() {
        selectedNode = null;
        updateButtonState();
        update();
    }

    function createNewNode() {
        const transform = d3.zoomTransform(svg.node());
        const x = (width / 2 - transform.x) / transform.k;
        const y = (height / 2 - transform.y) / transform.k;
        nodes.push({ id: Date.now(), label: "Mind", x: x, y: y });
        update(); saveData();
    }

    function deleteSelectedNode() {
        if (!selectedNode) return;
        
        // –£–¥–∞–ª—è–µ–º
        nodes = nodes.filter(n => n.id !== selectedNode.id);
        links = links.filter(l => l.source.id !== selectedNode.id && l.target.id !== selectedNode.id);
        
        selectedNode = null;
        updateButtonState();
        update();
        saveData();
    }

    // === –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–ï ===
    const renameModal = document.getElementById('rename-modal');
    const renameInput = document.getElementById('rename-input');

    function openRename() {
        if (!selectedNode) return;
        renameInput.value = selectedNode.label;
        renameModal.style.display = 'flex';
        // –§–æ–∫—É—Å —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã iOS
        setTimeout(() => renameInput.focus(), 100);
    }

    function closeRename() {
        renameModal.style.display = 'none';
    }

    function saveRename() {
        if (selectedNode && renameInput.value) {
            selectedNode.label = renameInput.value;
            update(); saveData();
        }
        closeRename();
    }

    // === D3 –õ–û–ì–ò–ö–ê ===

    function handleNodeClick(event, d) {
        if (event.defaultPrevented) return; // –ï—Å–ª–∏ —Ç–∞—â–∏–ª–∏

        if (selectedNode === null) {
            // –í—ã–±–æ—Ä –ø–µ—Ä–≤–æ–≥–æ —É–∑–ª–∞
            selectedNode = d;
        } else if (selectedNode === d) {
            // –¢–∞–ø–Ω—É–ª–∏ –ø–æ —É–∂–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É -> —Å–Ω—è—Ç—å –≤—ã–±–æ—Ä
            selectedNode = null;
        } else {
            // –¢–∞–ø–Ω—É–ª–∏ –ø–æ –¥—Ä—É–≥–æ–º—É -> –°–í–Ø–ó–ê–¢–¨
            const exists = links.some(l => 
                (l.source.id === selectedNode.id && l.target.id === d.id) ||
                (l.source.id === d.id && l.target.id === selectedNode.id)
            );
            if (!exists) { links.push({ source: selectedNode.id, target: d.id }); }
            else {
                links = links.filter(l => 
                    !((l.source.id === selectedNode.id && l.target.id === d.id) ||
                      (l.source.id === d.id && l.target.id === selectedNode.id))
                );
            }
            // –ü–æ—Å–ª–µ —Å–≤—è–∑–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∞ –≤–µ—Ä–Ω—É–ª–∞—Å—å –≤ "+"
            selectedNode = null;
            saveData();
        }
        updateButtonState(); // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
        update();
    }

    function update() {
        nodes.forEach(node => {
            const connections = links.filter(l => (l.source.id || l.source) === node.id || (l.target.id || l.target) === node.id).length;
            node.radius = 30 + (connections * 5);
        });

        const link = linkGroup.selectAll("line").data(links, d => (d.source.id || d.source) + "-" + (d.target.id || d.target));
        link.exit().remove();
        const linkEnter = link.enter().append("line").attr("class", "link");
        const allLinks = linkEnter.merge(link);

        const node = nodeGroup.selectAll("circle").data(nodes, d => d.id);
        node.exit().transition().duration(300).attr("r", 0).remove();
        
        const nodeEnter = node.enter().append("circle")
            .attr("class", "node")
            .attr("r", 0)
            .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended))
            .on("click", handleNodeClick);

        const allNodes = nodeEnter.merge(node);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        allNodes.attr("class", d => d === selectedNode ? "node selected" : "node")
                .transition().duration(300)
                .attr("r", d => d.radius);

        const text = textGroup.selectAll("text").data(nodes, d => d.id);
        text.exit().remove();
        const textEnter = text.enter().append("text").attr("class", "label").attr("dy", 5).text(d => d.label);
        const allTexts = textEnter.merge(text).text(d => d.label);

        simulation.nodes(nodes).on("tick", () => {
            allLinks.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            allNodes.attr("cx", d => d.x).attr("cy", d => d.y);
            allTexts.attr("x", d => d.x).attr("y", d => d.y);
        });
        
        simulation.force("link").links(links);
        simulation.alpha(0.5).restart();
    }

    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
    }
    function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null; d.fy = null;
        saveData();
    }

    // === –°–ò–°–¢–ï–ú–ù–´–ï ===
    function saveData() {
        const cleanNodes = nodes.map(n => ({ id: n.id, label: n.label, x: n.x, y: n.y }));
        const cleanLinks = links.map(l => ({ source: l.source.id || l.source, target: l.target.id || l.target }));
        localStorage.setItem('hrain_d3_v3', JSON.stringify({ nodes: cleanNodes, links: cleanLinks }));
    }
    function clearAllData() {
        if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë?")) { localStorage.removeItem('hrain_d3_v3'); location.reload(); }
    }

    updateButtonState();
    update();

</script>
</body>
</html>
