<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pocket L2 Idle — MMO Edition (Firestore)</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- D3.js (оставляем для зоны фарма) -->
<script src="https://d3js.org/d3.v7.min.js"></script> 
<!-- Firebase SDK -->
<script type="module">
    // Импорты Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, 
        onSnapshot, collection, query, where, setLogLevel,
        addDoc, serverTimestamp, orderBy, limit, runTransaction 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ FIREBASE ---
    let db, auth, app;
    let userId; // Уникальный ID игрока
    
    // Глобальные переменные из Canvas (НЕ ТРОГАТЬ)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- ИНИЦИАЛИЗАЦИЯ ИГРЫ (ТЕПЕРЬ ЗАПУСКАЕТСЯ ЧЕРЕЗ FIREBASE) ---
    
    // 1. Инициализация Firebase
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('Debug'); 
        console.log("Firebase Initialized. App ID:", appId);
        
        // --- ПРИВЯЗКА К ГЛОБАЛЬНОМУ ОБЪЕКТУ WINDOW ---
        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.firebaseFirestore = {
            doc, getDoc, setDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, where, 
            addDoc, serverTimestamp, orderBy, limit, runTransaction
        };
        
        // Функции игры
        window.start = start;
        window.toggleInventory = toggleInventory;
        window.buySS = buySS;
        window.toggleSS = toggleSS;
        window.toggleFarm = toggleFarm;
        window.useSkill = useSkill;
        window.showSkillInfo = showSkillInfo;
        window.hideSkillInfo = hideSkillInfo;
        window.enterZone = enterZone;
        window.handleMapClick = handleMapClick; 
        
        window.toggleChat = toggleChat; 
        window.sendChatMessage = sendChatMessage;
        
        window.toggleQuestLog = toggleQuestLog;
        window.acceptQuest = acceptQuest;
        window.turnInQuest = turnInQuest;
        
        window.toggleAuctionHouse = toggleAuctionHouse;
        window.renderAuctionSellTab = renderAuctionSellTab;
        window.listItemForSale = listItemForSale;
        window.buyAuctionItem = buyAuctionItem;
        
        window.toggleMailbox = toggleMailbox;
        window.claimMailItem = claimMailItem;
        window.deleteMailItem = deleteMailItem;
        
        // --- НОВЫЕ ФУНКЦИИ КРАФТА ---
        window.toggleCrafting = toggleCrafting;
        window.craftItem = craftItem;

    } catch (e) {
        console.error("Firebase Init Error:", e);
    }

    // 2. Аутентификация
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log("Auth state changed, user ID:", user.uid);
            userId = user.uid;
            // 3. Загружаем или создаем профиль игрока
            await loadOrCreatePlayerProfile(userId);
            // 4. Только теперь запускаем игру
            document.getElementById('menu').style.display='flex';
            // 5. Запускаем слушатель почты
            initMailListener(); 
        } else {
            console.log("No user signed in. Attempting sign in...");
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Sign-in error:", error);
            }
        }
    });

    // 3. Загрузка/Создание профиля
    async function loadOrCreatePlayerProfile(uid) {
        const playerProfileRef = doc(db, `artifacts/${appId}/users/${uid}/profile/data`);
        
        try {
            const docSnap = await getDoc(playerProfileRef);
            if (docSnap.exists()) {
                console.log("Loading existing profile...", docSnap.data());
                const loadedData = docSnap.data();
                // Загружаем сохраненные данные в 'p'
                p = { ...p, ...loadedData, userId: uid }; 
                // Убедимся, что квестовые поля существуют
                p.activeQuests = loadedData.activeQuests || {};
                p.completedQuests = loadedData.completedQuests || [];
            } else {
                console.log("No profile found, creating new one...");
                // Профиль не найден, создаем новый (данные из 'p' будут использованы при старте)
                p.userId = uid;
            }
        } catch (e) {
            console.error("Error loading/creating profile:", e);
        }
    }

</script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Roboto:wght@400;700&display=swap');
    
    body,html{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#0a001f;color:#fff;font-family:'Roboto', system-ui, sans-serif}
    #menu,#game{display:none;flex-direction:column;align-items:center;justify-content:center;height:100%;background:radial-gradient(circle at center,#2a0066,#0a001f)}
    h1{font-size:3.5rem;text-shadow:0 0 30px #ff00ff; font-family: 'Cinzel', serif;}
    button, .skill-btn { cursor: pointer; transition: all 0.3s; }
    
    /* --- ИЗМЕНЕНИЯ В UI --- */
    #game {
        background: #0a001f; /* Убираем градиент из игры, он будет на карте */
        justify-content: flex-start;
    }
    
    #stats{position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.75);padding:12px 16px;border-radius:12px;z-index:100; /* Выше карты */ font-size:14px; border: 1px solid #4a0072; max-width: 250px;}
    .bar{width:180px;height:14px;background:#222;border:1px solid #555;border-radius:7px;overflow:hidden;margin:4px 0}
    .fill{height:100%;transition:width .3s}
    
    #ss-toggle {
        width: 40px; height: 40px; border-radius: 8px; border: 2px solid #aaa;
        font-size: 16px; font-weight: bold; background: #333; color: #777;
        display: flex; align-items: center; justify-content: center; margin-top: 5px;
    }
    #ss-toggle.active { background: #ffc800; color: #000; border-color: #fff; box-shadow: 0 0 20px #ffc800; }
    
    #farm-toggle {
        width: 100%; height: 30px; border-radius: 8px; border: 2px solid #555;
        font-size: 14px; font-weight: bold; background: #333; color: #888;
        display: flex; align-items: center; justify-content: center; margin-top: 5px;
    }
    #farm-toggle.active { background: #16a34a; color: #fff; border-color: #22c55e; }

    .zone-btn {
        width: 100%; height: 30px; border-radius: 8px; border: 2px solid #555;
        font-size: 14px; font-weight: bold; background: #4a5568; color: #fff;
        display: flex; align-items: center; justify-content: center; margin-top: 5px;
    }
    
    .ui-btn {
        width: 100%; height: 30px; border-radius: 8px; border: 2px solid #555;
        font-size: 13px; font-weight: bold; background: #334155; color: #cbd5e1;
        display: flex; align-items: center; justify-content: center; margin-top: 5px;
        transition: background-color 0.2s;
    }
    .ui-btn:hover { background: #475569; }
    
    /* Иконка почты с уведомлением */
    #mail-btn-container {
        position: relative;
    }
    #mail-notification {
        position: absolute;
        top: 0px;
        right: 0px;
        width: 18px;
        height: 18px;
        background: #ef4444;
        border-radius: 50%;
        color: white;
        font-size: 12px;
        font-weight: bold;
        display: none; /* Скрыто по умолчанию */
        align-items: center;
        justify-content: center;
        border: 2px solid #fff;
    }

    #skills{
        position:absolute; bottom:20px; left:50%; transform:translateX(-50%);
        display:flex; gap: 4px; z-index:100; /* Выше карты */
        background: rgba(0,0,0,0.6); padding: 8px; border-radius: 12px; border: 1px solid #555;
    }
    /* ... (остальные стили UI без изменений) ... */
    
    /* --- СТИЛИ КАРТЫ ГИРАНА --- */
    #giran-map {
        width: 100%;
        height: 100%;
        position: relative;
        background: radial-gradient(circle at center, #2a0066, #0a001f);
        overflow: hidden;
        display: none; /* Скрыт по умолчанию */
    }
    .map-element {
        position: absolute;
        border-radius: 8px;
        box-sizing: border-box;
    }
    #giran-square {
        width: 400px;
        height: 400px;
        background: #3a1a66;
        border: 4px solid #5a3a86;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
    }
    #giran-statue {
        width: 60px;
        height: 60px;
        background: #9ca3af;
        border: 4px solid #e5e7eb;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-size: 10px;
        color: #1f2937;
        text-align: center;
        padding-top: 18px;
        font-weight: bold;
    }
    .giran-house {
        width: 150px;
        height: 100px;
        background: #4a2a77;
        border: 4px solid #6a4a97;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        font-weight: bold;
    }
    #trader-house {
        left: calc(50% + 250px);
        top: 50%;
        transform: translateY(-110%);
    }
    #quest-house {
        left: calc(50% + 250px);
        top: 50%;
        transform: translateY(10%);
    }
    /* Новые дома */
    #auction-house {
        left: calc(50% - 250px);
        top: 50%;
        transform: translate(-100%, -110%);
    }
    #mail-house {
        left: calc(50% - 250px);
        top: 50%;
        transform: translate(-100%, 10%);
    }
    /* Дом кузнеца */
    #crafting-house {
        left: 50%;
        top: calc(50% - 200px); /* Над площадью */
        transform: translate(-50%, -100%);
    }
    
    .npc-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid #fff;
        margin-bottom: 5px;
    }
    
    /* ... (стили игрока) ... */
    
    /* Скрыть D3 холст по умолчанию */
    #c { display: none; }
    
    /* ... (стили модалок, чата, квестов) ... */
    
    /* --- СТИЛИ АУКЦИОНА И ПОЧТЫ --- */
    .modal {
        position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:20;
        display:none; flex-direction:column; align-items:center; padding-top:50px;
    }
    .modal-content {
        width: 90%;
        max-width: 600px; 
        background: #1f2937;
        border: 1px solid #4a0072;
        border-radius: 12px;
        padding: 20px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }
    .modal-tabs {
        display: flex;
        border-bottom: 2px solid #374151;
        margin-bottom: 15px;
    }
    .tab-btn {
        padding: 10px 20px;
        background: #374151;
        color: #9ca3af;
        font-weight: bold;
        border-radius: 6px 6px 0 0;
    }
    .tab-btn.active {
        background: #4f46e5;
        color: #fff;
    }
    .tab-panel {
        display: none;
        flex-grow: 1;
        overflow-y: auto;
    }
    .tab-panel.active {
        display: block;
    }
    
    /* ... (стили аукциона и почты) ... */
    
    /* --- СТИЛИ КРАФТА --- */
    #crafting-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        flex-grow: 1;
        overflow-y: auto;
    }
    .craft-item {
        background: #374151;
        border-radius: 8px;
        padding: 15px;
    }
    .craft-name {
        font-size: 1.25rem;
        font-weight: bold;
        font-family: 'Cinzel', serif;
        color: #e5e7eb;
    }
    .craft-requires {
        font-size: 0.9rem;
        color: #d1d5db;
        margin: 8px 0;
        border-top: 1px solid #4b5563;
        padding-top: 8px;
    }
    .craft-requires-item {
        display: flex;
        justify-content: space-between;
    }
    .craft-requires-item.missing {
        color: #f87171; /* Красный, если не хватает */
    }
    .craft-chance {
        font-size: 1.1rem;
        font-weight: bold;
        color: #f59e0b; /* Оранжевый */
        text-align: center;
        margin: 10px 0;
    }
    .craft-btn {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        font-weight: bold;
        color: #fff;
        cursor: pointer;
        transition: background-color 0.2s;
        background-color: #db2777; /* Розовый */
        font-size: 1rem;
    }
    .craft-btn:hover { background-color: #ec4899; }
    .craft-btn:disabled {
        background-color: #4b5563;
        color: #9ca3af;
        cursor: not-allowed;
    }
    
    #inventory-modal, #quest-modal, #gameOverScreen, #auction-modal, #mail-modal, #crafting-modal { z-index: 200; }
    #chat-window { z-index: 150; }
    
</style>
</head>
<body>

<div id="menu" class="flex">
    <!-- ... (меню без изменений) ... -->
</div>

<div id="game" class="relative">
    <div id="stats">
        <!-- ... (статы) ... -->
        <div class="flex gap-2 w-full">
            <button onclick="toggleInventory()" class="ui-btn flex-1">Инвентарь</button>
            <button onclick="toggleChat()" class="ui-btn flex-1">Чат</button>
        </div>
        <div class="flex gap-2 w-full">
            <button onclick="toggleQuestLog()" class="ui-btn flex-1">Квесты</button>
            <div id="mail-btn-container" class="flex-1">
                <button onclick="toggleMailbox()" class="ui-btn w-full">Почта</button>
                <div id="mail-notification">!</div> <!-- Уведомление о почте -->
            </div>
        </div>
        <button onclick="toggleAuctionHouse()" class="ui-btn w-full">Аукцион</button>
        <button onclick="toggleCrafting()" class="ui-btn w-full bg-pink-700 hover:bg-pink-600">Крафт</button> <!-- <-- КНОПКА КРАФТА -->

        <button onclick="buySS(100)" class="mt-1 px-3 py-1 bg-yellow-600 rounded text-xs text-black w-full">Купить SS (100А)</button>
        <div id="farm-toggle" onclick="toggleFarm()">Фарм: OFF</div>
        
        <div class="mt-2 space-y-1">
            <div>Локация: <span id="zone-name" class="font-bold text-green-400"></span></div>
            <button id="go-to-city" class="zone-btn bg-blue-600 hover:bg-blue-500">В Гиран (Безоп.)</button>
            <button id="go-to-farm" class="zone-btn bg-red-600 hover:bg-red-500">На Поля (Фарм)</button>
        </div>
    </div>
    
    <!-- D3 ХОЛСТ (ТОЛЬКО ДЛЯ ФАРМ-ЗОНЫ) -->
    <svg id="c"></svg>
    
    <!-- НОВАЯ HTML КАРТА ГИРАНА -->
    <div id="giran-map" onclick="handleMapClick(event)">
        <div id="giran-square" class="map-element"></div>
        <div id="giran-statue" class="map-element">СТАТУЯ</div>
        
        <div id="trader-house" class="map-element giran-house">
            <div class="npc-icon" style="background-color: #00e6e6;"></div>
            Торговец
        </div>
        
        <div id="quest-house" class="map-element giran-house">
            <div class="npc-icon" style="background-color: #f59e0b;"></div>
            Мастер Квестов
        </div>
        
        <div id="auction-house" class="map-element giran-house">
            <div class="npc-icon" style="background-color: #16a34a;"></div>
            Аукционист
        </div>
        
        <div id="mail-house" class="map-element giran-house">
            <div class="npc-icon" style="background-color: #4f46e5;"></div>
            Почтальон
        </div>
        
        <div id="crafting-house" class="map-element giran-house">
            <div class="npc-icon" style="background-color: #db2777;"></div>
            Кузнец
        </div>
        
        <!-- Игрок и другие игроки будут добавлены сюда через JS -->
    </div>
    
    
    <div id="particles"></div>
    <!-- ... (остальные UI элементы: скиллы, инфо, модалки) ... -->
    
    <!-- --- ОКНО КРАФТА --- -->
    <div id="crafting-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-3xl mb-4 font-cinzel text-center">Кузница</h2>
            
            <div id="crafting-list" class="flex-grow overflow-y-auto">
                <!-- Рецепты крафта будут здесь -->
            </div>
            
            <div id="crafting-npc-message" class="text-center text-gray-400 mt-4" style="display: none;">
                Подойдите к Кузнецу в Гиране.
            </div>
        </div>
        <button onclick="toggleCrafting()" class="mt-8 px-8 py-4 bg-red-600 rounded text-xl">Закрыть</button>
    </div>

    <!-- ... (остальные модалки) ... -->
</div>

<audio id="sfx-adena" src="https://cdn.freesound.org/previews/657/657370_5674468-lq.mp3" preload="auto"></audio>
<audio id="sfx-hit" src="https://cdn.freesound.org/previews/612/612552_5674468-lq.mp3" preload="auto"></audio>
<audio id="sfx-buff" src="https://cdn.freesound.org/previews/276/276792_5123851-lq.mp3" preload="auto"></audio>
<audio id="sfx-lvl" src="https://cdn.freesound.org/previews/276/276285_5123851-lq.mp3" preload="auto"></audio>
<audio id="sfx-chat" src="https://cdn.freesound.org/previews/41/41108_5123851-lq.mp3" preload="auto"></audio> 
<audio id="sfx-quest" src="https://cdn.freesound.org/previews/270/270382_5123851-lq.mp3" preload="auto"></audio> 
<audio id="sfx-craft-fail" src="https://cdn.freesound.org/previews/258/258142_4100212-lq.mp3" preload="auto"></audio> <!-- <-- Крафт НЕУДАЧА -->
<audio id="sfx-craft-success" src="https://cdn.freesound.org/previews/403/403017_5123851-lq.mp3" preload="auto"></audio> <!-- <-- Крафт УСПЕХ -->


<script type="module">
// === КОНФИГУРАЦИЯ ИГРЫ ===
const AGGRO_RANGE = 150; 
const PULL_RANGE = 300; 
const MELEE_RANGE = 40;  
const NPC_INTERACT_RANGE = 120; 

// --- НОВЫЕ ПОЗИЦИИ NPC ---
let GiranTrader = { x: 0, y: 0, name: 'Торговец' }; 
let QuestMaster = { x: 0, y: 0, name: 'Мастер Квестов' }; 
let Auctioneer = { x: 0, y: 0, name: 'Аукционист' }; 
let Mailbox = { x: 0, y: 0, name: 'Почтальон' }; 
let Blacksmith = { x: 0, y: 0, name: 'Кузнец' }; // <-- НОВЫЙ NPC

const CLASS_STATS = { /* ... (без изменений) ... */ };
const CLASS_SKILLS = { /* ... (без изменений) ... */ };
const QUESTS_DB = { /* ... (без изменений) ... */ };

// --- БАЗА ДАННЫХ РЕЦЕПТОВ ---
const RECIPES_DB = {
    'd_sword': {
        id: 'd_sword',
        name: 'Меч Рыцаря (D-Grade)',
        requires: {
            'Обломок Кости': 20,
            'Нить': 10
        }
    },
    'c_bow': {
        id: 'c_bow',
        name: 'Эльфийский Лук (C-Grade)',
        requires: {
            'Обломок Кости': 50,
            'Нить': 25,
            'Меч Рыцаря (D-Grade)': 1 // Пример крафта из другого крафта
        }
    },
    'b_robe': {
        id: 'b_robe',
        name: 'Мантия Мага (B-Grade)',
        requires: {
            'Нить': 100
        }
    }
};

// === ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ИГРЫ ===
let p = {}; // Объект игрока
let svg, w, h, mobs = [], pool = [], cooldowns = {}, currentSkills = [];
let isGameOver = false;
let isActivelyFarming = false; 
let otherPlayers = new Map(); 
let playerUpdateInterval; 
let multiplayerUnsubscribe; 
let chatUnsubscribe; 
let mailUnsubscribe; 
let auctionUnsubscribe; 
let isChatOpen = false;
let isCrafting = false; // Защита от двойного клика по крафту

// --- НОВЫЕ ГЛОБАЛЬНЫЕ ДЛЯ HTML КАРТЫ ---
let playerElement; 
let giranMapElement; 
let otherPlayerElements = new Map(); 


// === ГЛОБАЛЬНЫЕ FIREBASE (ИЗ <head>/window) ===
const db = window.db;
const auth = window.auth;
const appId = window.appId;
const { 
    doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, 
    collection, query, where, addDoc, serverTimestamp, orderBy, limit, runTransaction
} = window.firebaseFirestore;

// === УТИЛИТЫ ===
function play(soundId) { /* ... (без изменений) ... */ }
function getDistance(n1, n2) { /* ... (без изменений) ... */ }

// === ЗАПУСК ИГРЫ (Вызывается из HTML) ===
window.start = async function() {
    const cls = document.getElementById('cls').value;
    const stats = CLASS_STATS[cls];
    w = innerWidth; h = innerHeight;
    
    // Заполняем 'p' данными, если это новый игрок
    p = {
        name: document.getElementById('name').value || 'Герой',
        cls, 
        color: stats.color,
        x: w/2, y: h/2, // Стартовая позиция
        maxHp: stats.hp, hp: stats.hp,
        maxMp: stats.mp, mp: stats.mp,
        baseAtk: stats.atk, atk: stats.atk,
        speed: stats.speed,
        level: 1, exp: 0, adena: 0,
        inventory: {'Обломок Кости': 50, 'Нить': 30}, // <-- Больше ресурсов для теста
        buffs: {},
        soulshots: 0, ssActive: false,
        target: null,
        currentZone: 'farm',
        activeQuests: {}, 
        completedQuests: [],
        ...p 
    };
    
    // Сохраняем профиль (на случай, если это первый вход)
    await savePlayerProfile();
    
    currentSkills = CLASS_SKILLS[cls];
    
    document.getElementById('pname').textContent = p.name + ' [' + cls.toUpperCase() + ']';
    document.getElementById('menu').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    
    initVisuals(); 
    initChatListener();
    initAuctionListener(); 
}

// === ИНИЦИАЛИЗАЦИЯ (ИЗМЕНЕНО) ===
function initVisuals() { 
    // --- Настройка D3 (Фарм-зона) ---
    svg = d3.select('#c').attr('width', w).attr('height', h);
    svg.append('rect').attr('width', w).attr('height', h).attr('fill', '#0f001f');

    // --- Настройка HTML Карты (Гиран) ---
    giranMapElement = document.getElementById('giran-map');
    
    // Создаем HTML-элемент для игрока
    playerElement = document.createElement('div');
    playerElement.className = 'player-entity';
    playerElement.innerHTML = `
        <div class="player-icon-circle" style="background-color: ${p.color};"></div>
        <div class="player-icon-name">${p.name}</div>
    `;
    giranMapElement.appendChild(playerElement);
    
    // Устанавливаем позиции NPC (центры зданий)
    const traderHouse = document.getElementById('trader-house');
    const questHouse = document.getElementById('quest-house');
    const auctionHouse = document.getElementById('auction-house');
    const mailHouse = document.getElementById('mail-house');
    const craftingHouse = document.getElementById('crafting-house'); // <-- Кузнец
    
    GiranTrader.x = traderHouse.offsetLeft + traderHouse.offsetWidth / 2;
    GiranTrader.y = traderHouse.offsetTop + traderHouse.offsetHeight / 2;
    QuestMaster.x = questHouse.offsetLeft + questHouse.offsetWidth / 2;
    QuestMaster.y = questHouse.offsetTop + questHouse.offsetHeight / 2;
    Auctioneer.x = auctionHouse.offsetLeft + auctionHouse.offsetWidth / 2;
    Auctioneer.y = auctionHouse.offsetTop + auctionHouse.offsetHeight / 2;
    Mailbox.x = mailHouse.offsetLeft + mailHouse.offsetWidth / 2;
    Mailbox.y = mailHouse.offsetTop + mailHouse.offsetHeight / 2;
    Blacksmith.x = craftingHouse.offsetLeft + craftingHouse.offsetWidth / 2;
    Blacksmith.y = craftingHouse.offsetTop + craftingHouse.offsetHeight / 2;
    
    // Скиллы
    document.querySelectorAll('.skill-btn').forEach((btn, i) => {
        const skill = currentSkills[i];
        btn.textContent = skill.icon;
        btn.style.background = skill.color;
    });
    
    // Кнопки зон
    document.getElementById('go-to-city').onclick = () => enterZone('city');
    document.getElementById('go-to-farm').onclick = () => enterZone('farm');

    // Запуск
    enterZone('farm'); // Начинаем на фарме
    updateUI();
    requestAnimationFrame(loop);
}

// --- НОВАЯ ФУНКЦИЯ КЛИКА ПО КАРТЕ ---
window.handleMapClick = function(event) {
    if (isGameOver || p.currentZone !== 'city') return;
    
    // Игнорируем клики по UI поверх карты
    const modalOpen = document.querySelector('.modal[style*="display: flex"]');
    if (modalOpen || event.target.closest('.map-element') && event.target.id !== 'giran-map' && event.target.id !== 'giran-square') {
        return;
    }
    if (event.target.closest('.player-entity')) return;

    // Получаем координаты клика относительно карты
    const rect = giranMapElement.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;

    p.x = x;
    p.y = y;
    
    // Двигаем HTML-элемент игрока
    playerElement.style.transform = `translate(${p.x - playerElement.offsetWidth/2}px, ${p.y - playerElement.offsetHeight/2}px)`;
}

// === ЛОГИКА ЗОН (СИЛЬНО ИЗМЕНЕНО) ===
window.enterZone = async function(zoneName) {
    if (!p || !p.userId) return; 
    
    p.currentZone = zoneName;
    const cityBtn = document.getElementById('go-to-city');
    const farmBtn = document.getElementById('go-to-farm');
    const farmToggle = document.getElementById('farm-toggle');
    
    // Элементы D3 и HTML
    const d3Canvas = document.getElementById('c');
    const htmlMap = document.getElementById('giran-map');
    
    const playerPublicRef = doc(db, `artifacts/${appId}/public/data/players/${p.userId}`);

    if (zoneName === 'city') {
        document.getElementById('zone-name').textContent = 'Гиран';
        cityBtn.style.display = 'none';
        farmBtn.style.display = 'block';
        farmToggle.style.display = 'none'; 
        
        d3Canvas.style.display = 'none'; // Скрываем D3
        htmlMap.style.display = 'block'; // Показываем HTML карту
        
        if (isActivelyFarming) toggleFarm(); 
        
        // Убираем D3-мобов
        svg.selectAll('.mob-node').remove(); 
        mobs = []; pool = [];
        
        // Позиционируем игрока на карте
        p.x = w / 2; p.y = h / 2 + 150; // Точка входа в город
        playerElement.style.transform = `translate(${p.x - playerElement.offsetWidth/2}px, ${p.y - playerElement.offsetHeight/2}px)`;

        // --- МУЛЬТИПЛЕЕР: Вход в город ---
        try {
            await setDoc(playerPublicRef, {
                x: p.x, y: p.y, name: p.name, color: p.color, userId: p.userId
            });
        } catch(e) { console.error("Failed to publish player location:", e); }
        
        if (playerUpdateInterval) clearInterval(playerUpdateInterval);
        playerUpdateInterval = setInterval(updatePlayerPosition, 200);
        
        setupMultiplayerListeners(); // Подписываемся на других

    } else { // 'farm'
        document.getElementById('zone-name').textContent = 'Поля';
        cityBtn.style.display = 'block';
        farmBtn.style.display = 'none';
        farmToggle.style.display = 'block'; 
        
        d3Canvas.style.display = 'block'; // Показываем D3
        htmlMap.style.display = 'none'; // Скрываем HTML карту
        
        // --- МУЛЬТИПЛЕЕР: Выход из города ---
        try {
            await deleteDoc(playerPublicRef);
        } catch(e) { console.error("Failed to delete player location:", e); }
        
        clearInterval(playerUpdateInterval);
        
        if (multiplayerUnsubscribe) multiplayerUnsubscribe();
        
        // Очищаем HTML-карту от других игроков
        otherPlayers.clear();
        otherPlayerElements.forEach(el => el.remove());
        otherPlayerElements.clear();
        
        // Спавним D3-мобов
        p.x = w / 2; p.y = h / 2; // Центрируем для D3
        for(let i=0;i<10;i++) spawnMob();
    }
}

// === МУЛЬТИПЛЕЕР (ИЗМЕНЕНО ДЛЯ HTML) ===
function setupMultiplayerListeners() {
    if (multiplayerUnsubscribe) multiplayerUnsubscribe();
    const playersQuery = query(collection(db, `artifacts/${appId}/public/data/players`));
    multiplayerUnsubscribe = onSnapshot(playersQuery, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            const data = change.doc.data();
            if (data.userId === p.userId) return; 
            if (change.type === "added" || change.type === "modified") {
                otherPlayers.set(data.userId, data);
                renderOtherPlayer(data);
            }
            if (change.type === "removed") {
                otherPlayers.delete(data.userId);
                if (otherPlayerElements.has(data.userId)) {
                    otherPlayerElements.get(data.userId).remove();
                    otherPlayerElements.delete(data.userId);
                }
            }
        });
    });
}
function renderOtherPlayer(data) {
    let el;
    if (otherPlayerElements.has(data.userId)) {
        el = otherPlayerElements.get(data.userId);
    } else {
        el = document.createElement('div');
        el.className = 'player-entity other-player-icon';
        el.innerHTML = `
            <div class="player-icon-circle" style="background-color: ${data.color || '#ccc'};"></div>
            <div class="player-icon-name">${data.name}</div>
        `;
        giranMapElement.appendChild(el);
        otherPlayerElements.set(data.userId, el);
    }
    el.style.transform = `translate(${data.x - el.offsetWidth/2}px, ${data.y - el.offsetHeight/2}px)`;
}
async function updatePlayerPosition() {
    if (p.currentZone !== 'city' || !p.userId) return;
    const playerPublicRef = doc(db, `artifacts/${appId}/public/data/players/${p.userId}`);
    try {
        await setDoc(playerPublicRef, { x: p.x, y: p.y }, { merge: true });
    } catch (e) {
        console.error("Position update failed:", e);
    }
}

// === СОХРАНЕНИЕ ПРОФИЛЯ (FIRESTORE) ===
async function savePlayerProfile() {
    if (!p.userId) {
        console.warn("Attempted to save profile, but userId is missing.");
        return;
    }
    const playerProfileRef = doc(db, `artifacts/${appId}/users/${p.userId}/profile/data`);
    
    const dataToSave = {
        name: p.name,
        cls: p.cls,
        color: p.color,
        maxHp: p.maxHp, hp: p.hp,
        maxMp: p.maxMp, mp: p.mp,
        baseAtk: p.baseAtk,
        speed: p.speed,
        level: p.level, 
        exp: p.exp, 
        adena: p.adena,
        inventory: p.inventory,
        soulshots: p.soulshots,
        activeQuests: p.activeQuests, 
        completedQuests: p.completedQuests
    };

    try {
        await setDoc(playerProfileRef, dataToSave, { merge: true });
        console.log("Profile saved.");
    } catch (e) {
        console.error("Error saving profile:", e);
    }
}


// === ИНВЕНТАРЬ И МАГАЗИН (С ПРОВЕРКОЙ NPC) ===
window.toggleInventory = function() {
    if (p.currentZone !== 'city' || getDistance(p, GiranTrader) > NPC_INTERACT_RANGE) {
        showFloatingMessage('Подойдите к Торговцу!', p.x, p.y - 50, '#ff4444');
        return;
    }
    const modal = document.getElementById('inventory-modal');
    modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
    if (modal.style.display === 'flex') renderInventory();
}
function renderInventory() { /* ... (без изменений) ... */ }
window.buySS = async function(cost) { /* ... (без изменений) ... */ }

// === ЛОГИКА ЧАТА ===
window.toggleChat = function() { /* ... (без изменений) ... */ }
window.sendChatMessage = async function() { /* ... (без изменений) ... */ }
function initChatListener() { /* ... (без изменений) ... */ }
// === КОНЕЦ ЛОГИКИ ЧАТА ===

// === ЛОГИКА КВЕСТОВ ===
window.toggleQuestLog = function() {
    const modal = document.getElementById('quest-modal');
    const msg = document.getElementById('quest-npc-message');
    const isNearQuestMaster = p.currentZone === 'city' && getDistance(p, QuestMaster) <= NPC_INTERACT_RANGE;
    
    modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
    msg.style.display = isNearQuestMaster ? 'none' : 'block';
    
    if (modal.style.display === 'flex') {
        renderQuestLog(isNearQuestMaster);
    }
}
function renderQuestLog(isNearNPC) { /* ... (без изменений) ... */ }
window.acceptQuest = async function(questId) { /* ... (без изменений) ... */ }
window.turnInQuest = async function(questId) { /* ... (без изменений) ... */ }
// --- КОНЕЦ ЛОГИКИ КВЕСТОВ ---

// === ЛОГИКА АУКЦИОНА ===
window.toggleAuctionHouse = function() {
    const modal = document.getElementById('auction-modal');
    const msg = document.getElementById('auction-npc-message');
    const isNear = p.currentZone === 'city' && getDistance(p, Auctioneer) <= NPC_INTERACT_RANGE;
    
    modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
    msg.style.display = isNear ? 'none' : 'block';
    
    document.getElementById('auction-buy-panel').style.display = isNear ? 'block' : 'none';
    document.getElementById('auction-sell-panel').style.display = 'none';
    document.querySelector('#auction-modal .modal-tabs').style.display = isNear ? 'flex' : 'none';
    document.getElementById('auction-buy-tab-btn').click();
}
function initAuctionListener() {
    if (auctionUnsubscribe) auctionUnsubscribe(); 
    const ahColRef = collection(db, `artifacts/${appId}/public/data/auction_house`);
    const q = query(ahColRef, orderBy('listedAt', 'desc')); 
    
    auctionUnsubscribe = onSnapshot(q, (snapshot) => {
        const buyList = document.getElementById('auction-buy-list');
        buyList.innerHTML = '';
        if (snapshot.empty) {
            buyList.innerHTML = '<div class="text-sm text-gray-400 p-4 text-center">На рынке пусто.</div>';
            return;
        }
        snapshot.forEach(doc => {
            const item = doc.data();
            const docId = doc.id;
            const isMine = item.sellerId === p.userId;
            buyList.innerHTML += `
                <div class="auction-item">
                    <div class="item-name">${item.itemName} x${item.count}</div>
                    <div class="item-price">${item.price} Аден</div>
                    <div class="item-seller">Продавец: ${item.sellerName}</div>
                    <button class="item-buy-btn" onclick="buyAuctionItem('${docId}')" ${isMine ? 'disabled' : ''}>
                        ${isMine ? 'Ваш лот' : 'Купить'}
                    </button>
                </div>
            `;
        });
    }, (error) => {
        console.error("Auction listener error:", error);
        document.getElementById('auction-buy-list').innerHTML = '<div class="text-red-500 p-4 text-center">Ошибка загрузки аукциона.</div>';
    });
}
window.renderAuctionSellTab = function() {
    const sellList = document.getElementById('auction-sell-list');
    sellList.innerHTML = '';
    if (Object.keys(p.inventory).length === 0) {
        sellList.innerHTML = '<div class="text-sm text-gray-400 p-4 text-center">Ваш инвентарь пуст.</div>';
        return;
    }
    for (const [itemName, count] of Object.entries(p.inventory)) {
        sellList.innerHTML += `
            <div class="sell-item">
                <div class="sell-item-name">${itemName}</div>
                <div class="sell-item-count">В наличии: ${count}</div>
                <input type="number" id="price-${itemName.replace(/\s/g, '')}" class="sell-item-input" placeholder="Цена за 1 шт.">
                <input type="number" id="count-${itemName.replace(/\s/g, '')}" class="sell-item-input" placeholder="Кол-во (макс. ${count})" value="${count}" max="${count}">
                <button class="sell-item-btn" onclick="listItemForSale('${itemName}')">Выставить</button>
            </div>
        `;
    }
}
window.listItemForSale = async function(itemName) {
    const priceInput = document.getElementById(`price-${itemName.replace(/\s/g, '')}`);
    const countInput = document.getElementById(`count-${itemName.replace(/\s/g, '')}`);
    const pricePerItem = parseInt(priceInput.value, 10);
    const countToList = parseInt(countInput.value, 10);
    if (!pricePerItem || pricePerItem <= 0 || !countToList || countToList <= 0) {
        showFloatingMessage('Неверная цена или кол-во', p.x, p.y, '#ff4444');
        return;
    }
    if (countToList > p.inventory[itemName]) {
        showFloatingMessage('Недостаточно предметов', p.x, p.y, '#ff4444');
        return;
    }
    try {
        p.inventory[itemName] -= countToList;
        if (p.inventory[itemName] <= 0) {
            delete p.inventory[itemName];
        }
        const ahColRef = collection(db, `artifacts/${appId}/public/data/auction_house`);
        await addDoc(ahColRef, {
            itemName: itemName,
            count: countToList,
            price: pricePerItem * countToList,
            sellerId: p.userId,
            sellerName: p.name,
            listedAt: serverTimestamp()
        });
        await savePlayerProfile();
        play('sfx-quest');
        showFloatingMessage('Лот выставлен!', p.x, p.y, '#a5f3fc');
        renderAuctionSellTab();
    } catch (e) {
        console.error("Error listing item:", e);
        showFloatingMessage('Ошибка. Попробуйте снова.', p.x, p.y, '#ff4444');
    }
}
window.buyAuctionItem = async function(docId) {
    if (!docId) return;
    const itemRef = doc(db, `artifacts/${appId}/public/data/auction_house/${docId}`);
    try {
        await runTransaction(db, async (transaction) => {
            const itemDoc = await transaction.get(itemRef);
            if (!itemDoc.exists()) throw new Error("Лот уже продан!");
            const item = itemDoc.data();
            if (item.sellerId === p.userId) throw new Error("Нельзя купить свой лот.");
            if (p.adena < item.price) throw new Error("Недостаточно Адены!");
            p.adena -= item.price;
            p.inventory[item.itemName] = (p.inventory[item.itemName] || 0) + item.count;
            transaction.delete(itemRef);
            const mailColRef = collection(db, `artifacts/${appId}/public/data/mail`);
            const mailMessage = {
                recipientId: item.sellerId,
                senderName: "Аукцион",
                text: `Ваш лот продан: ${item.itemName} x${item.count}`,
                reward: { adena: item.price },
                sentAt: serverTimestamp()
            };
            const newMailRef = doc(collection(db, `artifacts/${appId}/public/data/mail`));
            transaction.set(newMailRef, mailMessage);
        });
        await savePlayerProfile();
        play('sfx-adena');
        showFloatingMessage('Предмет куплен!', p.x, p.y, '#fcd34d');
    } catch (e) {
        console.error("Buy transaction failed: ", e);
        showFloatingMessage(e.message, p.x, p.y, '#ff4444');
    }
}
// === КОНЕЦ ЛОГИКИ АУКЦИОНА ===

// === ЛОГИКА ПОЧТЫ ===
window.toggleMailbox = function() {
    const modal = document.getElementById('mail-modal');
    const msg = document.getElementById('mail-npc-message');
    const isNear = p.currentZone === 'city' && getDistance(p, Mailbox) <= NPC_INTERACT_RANGE;
    modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
    msg.style.display = isNear ? 'none' : 'block';
    document.getElementById('mail-list').style.display = isNear ? 'block' : 'none';
    if (isNear) {
        document.getElementById('mail-notification').style.display = 'none';
    }
}
function initMailListener() {
    if (mailUnsubscribe) mailUnsubscribe(); 
    const mailColRef = collection(db, `artifacts/${appId}/public/data/mail`);
    const q = query(mailColRef, where("recipientId", "==", p.userId), orderBy('sentAt', 'desc'));
    const mailList = document.getElementById('mail-list');
    const notification = document.getElementById('mail-notification');
    mailUnsubscribe = onSnapshot(q, (snapshot) => {
        if (snapshot.empty) {
            mailList.innerHTML = '<div class="text-sm text-gray-400 p-4 text-center">Почтовый ящик пуст.</div>';
            notification.style.display = 'none';
            return;
        }
        notification.style.display = 'flex';
        mailList.innerHTML = '';
        snapshot.forEach(doc => {
            const mail = doc.data();
            const docId = doc.id;
            const hasReward = mail.reward && mail.reward.adena > 0;
            mailList.innerHTML += `
                <div class="mail-item">
                    <div class="mail-text">
                        <span class="font-bold">От: ${mail.senderName}</span>
                        <p>${mail.text}</p>
                    </div>
                    <div class="mail-reward">
                        ${hasReward ? `${mail.reward.adena} Аден` : 'Нет вложений'}
                    </div>
                    <div class="flex flex-col gap-1">
                        ${hasReward ? `
                            <button class="mail-action-btn" onclick="claimMailItem('${docId}')">Забрать</button>
                        ` : `
                            <button class="mail-action-btn mail-delete-btn" onclick="deleteMailItem('${docId}')">Удалить</button>
                        `}
                    </div>
                </div>
            `;
        });
    }, (error) => {
        console.error("Mail listener error:", error);
        mailList.innerHTML = '<div class="text-red-500 p-4 text-center">Ошибка загрузки почты.</div>';
    });
}
window.claimMailItem = async function(docId) {
    const mailRef = doc(db, `artifacts/${appId}/public/data/mail/${docId}`);
    try {
        const mailDoc = await getDoc(mailRef);
        if (!mailDoc.exists()) throw new Error("Письмо уже удалено.");
        const mail = mailDoc.data();
        if (mail.recipientId !== p.userId) throw new Error("Это не ваше письмо.");
        if (mail.reward && mail.reward.adena) {
            p.adena += mail.reward.adena;
        }
        await deleteDoc(mailRef);
        await savePlayerProfile();
        play('sfx-adena');
        updateUI();
    } catch (e) {
        console.error("Error claiming mail:", e);
        showFloatingMessage(e.message, p.x, p.y, '#ff4444');
    }
}
window.deleteMailItem = async function(docId) {
    await deleteDoc(doc(db, `artifacts/${appId}/public/data/mail/${docId}`));
}
// === КОНЕЦ ЛОГИКИ ПОЧТЫ ===

// === НОВАЯ ЛОГИКА: КРАФТ ===
window.toggleCrafting = function() {
    const modal = document.getElementById('crafting-modal');
    const msg = document.getElementById('crafting-npc-message');
    const isNear = p.currentZone === 'city' && getDistance(p, Blacksmith) <= NPC_INTERACT_RANGE;
    
    modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
    msg.style.display = isNear ? 'none' : 'block';
    
    document.getElementById('crafting-list').style.display = isNear ? 'grid' : 'none';
    
    if (isNear) {
        renderCraftingRecipes();
    }
}

function renderCraftingRecipes() {
    const list = document.getElementById('crafting-list');
    list.innerHTML = '';
    
    for (const recipeId in RECIPES_DB) {
        const recipe = RECIPES_DB[recipeId];
        let requirementsHTML = '';
        let canCraft = true;
        
        for (const [itemName, requiredCount] of Object.entries(recipe.requires)) {
            const hasCount = p.inventory[itemName] || 0;
            const hasEnough = hasCount >= requiredCount;
            if (!hasEnough) canCraft = false;
            
            requirementsHTML += `
                <div class="craft-requires-item ${!hasEnough ? 'missing' : ''}">
                    <span>${itemName}</span>
                    <span>${hasCount} / ${requiredCount}</span>
                </div>
            `;
        }
        
        list.innerHTML += `
            <div class="craft-item">
                <div class="craft-name">${recipe.name}</div>
                <div class="craft-requires">${requirementsHTML}</div>
                <div class="craft-chance">Шанс успеха: 50%</div>
                <button class="craft-btn" 
                        onclick="craftItem('${recipeId}')" 
                        ${!canCraft ? 'disabled' : ''}>
                    ${canCraft ? 'Создать' : 'Недостаточно ресурсов'}
                </button>
            </div>
        `;
    }
}

window.craftItem = async function(recipeId) {
    if (isCrafting) return; // Защита от двойного клика
    isCrafting = true;
    
    const recipe = RECIPES_DB[recipeId];
    if (!recipe) {
        isCrafting = false;
        return;
    }
    
    // 1. Проверяем ресурсы (еще раз, на всякий случай)
    let canCraft = true;
    for (const [itemName, requiredCount] of Object.entries(recipe.requires)) {
        if ((p.inventory[itemName] || 0) < requiredCount) {
            canCraft = false;
            break;
        }
    }
    
    if (!canCraft) {
        showFloatingMessage('Недостаточно ресурсов', p.x, p.y, '#ff4444');
        isCrafting = false;
        return;
    }
    
    // 2. Забираем ресурсы
    for (const [itemName, requiredCount] of Object.entries(recipe.requires)) {
        p.inventory[itemName] -= requiredCount;
        if (p.inventory[itemName] <= 0) {
            delete p.inventory[itemName];
        }
    }
    
    // 3. Бросаем кубик (50% шанс)
    const success = Math.random() < 0.5;
    
    if (success) {
        // --- УСПЕХ ---
        play('sfx-craft-success');
        showFloatingMessage(`УСПЕХ! Создан: ${recipe.name}`, p.x, p.y, '#fcd34d');
        
        // Добавляем предмет в инвентарь
        p.inventory[recipe.name] = (p.inventory[recipe.name] || 0) + 1;
        
    } else {
        // --- НЕУДАЧА ---
        play('sfx-craft-fail');
        showFloatingMessage('НЕУДАЧА! Ресурсы потеряны.', p.x, p.y, '#ff4444');
        // Ресурсы уже забрали, предмет не даем.
    }
    
    // 4. Сохраняем и обновляем UI
    await savePlayerProfile();
    renderCraftingRecipes(); // Обновляем список (кнопки могут стать disabled)
    
    // Снимаем блокировку
    setTimeout(() => { isCrafting = false; }, 1000); // 1 сек кулдаун на крафт
}
// === КОНЕЦ ЛОГИКИ КРАФТА ===


// === ОСТАЛЬНАЯ ЛОГИКА ИГРЫ ===
/* ... (toggleSS, toggleFarm, useSkill, spawnMob, loop, checkLevel, updateUI и т.д. ... ) */
/* ... (без изменений) ... */
window.toggleSS = function() { /* ... (без изменений) ... */ }
window.toggleFarm = function() { /* ... (без изменений) ... */ }
window.showSkillInfo = function(id) { /* ... (без изменений) ... */ }
window.hideSkillInfo = function() { /* ... (без изменений) ... */ }
window.useSkill = function(id) { /* ... (без изменений) ... */ }
function applyBuff(buff) { /* ... (без изменений) ... */ }
function recalculateStats() { /* ... (без изменений) ... */ }
function spawnMob() {
    if (p.currentZone === 'city') return;
    let g = pool.length ? pool.pop() : svg.append('g').attr('class', 'mob-node');
    const a = Math.random()*Math.PI*2;
    const d = 300 + Math.random()*400;
    const x = p.x + Math.cos(a)*d;
    const y = p.y + Math.sin(a)*d;
    g.attr('transform', `translate(${x},${y})`).style('display', '');
    if (!g.select('circle').node()) {
        g.append('circle').attr('class', 'mob-body').attr('r', 16).attr('fill', '#555').attr('stroke', '#888').attr('stroke-width', 3);
        g.append('rect').attr('class', 'hp-bg').attr('width', 30).attr('height', 4).attr('x', -15).attr('y', -25).attr('fill', '#333');
        g.append('rect').attr('class', 'hp-fill').attr('width', 30).attr('height', 4).attr('x', -15).attr('y', -25).attr('fill', '#ef4444');
    }
    const mobData = { g, x, y, maxHp: 60 + p.level*18, hp: 60 + p.level*18, atk: 5 + p.level * 2, speed: 1.5 + p.level * 0.05, lastAttackTime: 0, aggro: false };
    g.datum(mobData); 
    mobs.push(mobData);
}
function createEffect(x, y, type) { /* ... (без изменений) ... */ }
const particlePool = [];
function createParticles(x, y, color = "#fff", count = 12) { /* ... (без изменений) ... */ }
function showFloatingMessage(text, x, y, color = '#ff4444') { /* ... (без изменений) ... */ }
function gameOver() {
    if (isGameOver) return;
    isGameOver = true;
    document.getElementById('gameOverScreen').style.display = 'flex';
    play('sfx-lvl'); 
    clearInterval(playerUpdateInterval);
    if (chatUnsubscribe) chatUnsubscribe();
    if (mailUnsubscribe) mailUnsubscribe();
    if (auctionUnsubscribe) auctionUnsubscribe();
}
function findNewTarget() { /* ... (без изменений) ... */ }
function activeFarmLogic(delta) {
    if (p.currentZone !== 'farm') return;
    if (!p.target) {
        findNewTarget();
        if (!p.target) return; 
    }
}

// === ГЛАВНЫЙ ЦИКЛ ===
let last = 0;
let lastSave = 0; 
function loop(t) {
    if (isGameOver || !p.userId) { 
        requestAnimationFrame(loop);
        return;
    }
    const delta = (t - last) || 16.67;
    last = t;
    if (t - lastSave > 10000) { 
        savePlayerProfile();
        lastSave = t;
    }
    p.mp = Math.min(p.maxMp, p.mp + (p.maxMp * 0.002 * (delta/16.67)));
    p.hp = Math.min(p.maxHp, p.hp + (p.maxHp * 0.001 * (delta/16.67)));
    if (p.hp <= 0) { gameOver(); return; }
    if (p.currentZone === 'farm') {
        if (isActivelyFarming) {
            activeFarmLogic(delta);
        }
        for(let i=mobs.length-1;i>=0;i--) {
            const m = mobs[i];
            if (m.hp <= 0) continue; 
            const dist = getDistance(m, p);
            if (!m.aggro && !isActivelyFarming && dist < AGGRO_RANGE) m.aggro = true;
            if (!m.aggro) {
                 m.g.select('.mob-body').attr('fill', '#555'); 
                 continue;
            }
            m.g.select('.mob-body').attr('fill', '#7f1d1d'); 
            if (dist > MELEE_RANGE) { 
                const dx = p.x - m.x;
                const dy = p.y - m.y;
                m.x += (dx / dist) * m.speed * (delta/16.67);
                m.y += (dy / dist) * m.speed * (delta/16.67);
                m.g.attr('transform', `translate(${m.x},${m.y})`);
            } else { 
                if (t - m.lastAttackTime > 2000) { 
                    p.hp -= m.atk;
                    m.lastAttackTime = t;
                    play('sfx-hit');
                    document.body.style.animation = 'shake 0.3s';
                    setTimeout(()=>document.body.style.animation='', 300);
                }
            }
            if (dist < PULL_RANGE) { 
                let damage = p.atk * 0.005 * delta; 
                if (p.ssActive && p.soulshots > 0 && t % 1000 < delta) { 
                    damage *= 2.0; p.soulshots--; updateUI();
                }
                m.hp -= damage; 
                if (t % 500 < delta) createParticles(m.x, m.Y, p.color, 4);
                m.g.select('.hp-fill').attr('width', Math.max(0, (m.hp / m.maxHp) * 30));
                if (m.hp <= 0) {
                    p.adena += 9 + Math.floor(Math.random()*13);
                    p.exp += 13 + p.level * 2;
                    if (p.target === m) p.target = null; 
                    let droppedItem = null;
                    if (Math.random() < 0.3) { 
                        droppedItem = 'Обломок Кости';
                    } else if (Math.random() < 0.1) {
                        droppedItem = 'Нить';
                    }
                    if (droppedItem) {
                         p.inventory[droppedItem] = (p.inventory[droppedItem] || 0) + 1;
                    }
                    for (const questId in p.activeQuests) {
                        const quest = QUESTS_DB[questId];
                        const activeQuest = p.activeQuests[questId];
                        if (quest.type === 'kill' && activeQuest.progress < quest.targetCount) {
                            activeQuest.progress++;
                        }
                    }
                    createParticles(m.x, m.y, '#ffd700', 16);
                    play('sfx-adena');
                    m.g.style('display', 'none');
                    pool.push(m.g);
                    mobs.splice(i,1);
                    checkLevel();
                    if (mobs.length < 9) spawnMob(); 
                }
            }
        }
    } 
    updateUI();
    Object.keys(cooldowns).forEach(k => cooldowns[k] > delta && (cooldowns[k] -= delta));
    requestAnimationFrame(loop);
}

// === ЛВЛ-АП ===
function checkLevel() { /* ... (без изменений) ... */ }
function updateUI() { /* ... (без изменений) ... */ }

</script>
</body>
</html>


