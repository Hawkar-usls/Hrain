<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Pocket Lineage 2: Essence Auto-Farm</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0a;
      --wall: #222;
      --floor: #111;
      --red: #ff4444;
      --green: #44ff44;
      --ui-height: 240px; 
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: var(--bg);
      color: #ffcc80;
      font-family: 'Press Start 2P', cursive;
      overflow: hidden;
      user-select: none;
      touch-action: none;
    }
    #game { 
      display: flex; 
      flex-direction: column; 
      height: 100vh; 
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    canvas {
      image-rendering: pixelated;
      background: var(--floor);
      box-shadow: 0 0 30px #330000 inset;
      flex-grow: 1;
    }
    #ui-container {
      display: flex; 
      flex-direction: column; 
      height: var(--ui-height);
    }
    #ui {
      padding: 15px;
      background: #111;
      border-top: 3px solid #444;
      font-size: 12px;
      flex-shrink: 0;
    }
    #log {
      height: 100%;
      overflow-y: auto;
      background: #000;
      padding: 10px;
      border: 2px solid #444;
      margin-top: 5px;
      border-radius: 8px;
      font-size: 11px;
      color: #ccc;
      flex-grow: 1;
      max-height: 60px;
      order: 3;
    }

    .bar {
      height: 18px;
      background: #222;
      border: 2px solid #555;
      margin: 5px 0;
      border-radius: 9px;
      overflow: hidden;
    }
    .fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b6b, #feca57, #a0e7a0);
      border-radius: 6px;
      transition: width 0.4s ease;
    }
    .label {
      margin: 4px 0 2px;
      color: #ffcc80;
      display: flex;
      justify-content: space-between;
    }
    
    h1 {
      font-size: 16px;
      color: #ff6b6b;
      text-align: center;
      margin-bottom: 5px;
      text-shadow: 0 0 10px #ff0000;
    }

    .shop-btn {
        font-family:'Press Start 2P', cursive; 
        font-size:8px; 
        padding:5px; 
        margin: 2px;
        background: #333; 
        color: #ffcc80; 
        border: 2px solid #555; 
        border-radius:5px;
        flex-grow: 1;
        min-width: 0;
    }

    /* –ö–ù–û–ü–ö–ê –§–ê–†–ú–ê (–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞) */
    #statusBtn {
        position: absolute;
        right: 20px; 
        bottom: calc(20px + var(--ui-height));
        width: 100px; height: 100px;
        background: radial-gradient(circle, #00ff00, #009900);
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #fff;
        font-weight: bold;
        box-shadow: 0 0 25px #00ff00;
        z-index: 100;
        border: 4px solid #00ff00;
    }
    
    .spoil-effect {
      position: absolute;
      color: #ffd700;
      font-weight: bold;
      pointer-events: none;
      animation: float 1s ease-out forwards;
      z-index: 50;
    }
    @keyframes float {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-50px); opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="game">
    <canvas id="canvas"></canvas>

    <div id="statusBtn">
      <div style="font-size:18px">üü¢</div>
      FARM
    </div>

    <div id="ui-container">
        <div id="ui">
            <h1>Pocket L2: Essence AFK</h1>
            <div class="label">–£—Ä–æ–≤–µ–Ω—å: <span id="level">1</span> (STR: <span id="str">16</span> | DEF: <span id="def">9</span>)</div>
            <div class="bar"><div id="expBar" class="fill" style="width:0%"></div></div>

            <div class="label">–°–ø–æ–π–ª LVL: <span id="spoilLevel">1</span> | –ö—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏—è: <span id="crystalChance">0%</span></div>
            <div class="bar"><div id="spoilBar" class="fill" style="width:0%"></div></div>

            <div class="label">–ê–¥–µ–Ω: <span id="adena">0</span> | –ü—É–¥—Ä—ã (C): <span id="crystals">0</span> | –ú–∞—Ç-–ª—ã (M): <span id="mats">0</span></div>
            <div class="label" style="font-size:10px; color:#ffd700;">SPOIL CHANCE BONUS: <span id="allySpoilBonus">0%</span> | HP Reg: <span id="hpReg">0</span>/s</div>
            
            <div style="display:flex; justify-content: space-around; margin-top:10px;">
                <button id="buyWeapon" class="shop-btn">–û—Ä—É–∂–∏–µ +1 STR [500 A]</button>
                <button id="buyArmor" class="shop-btn">–ë—Ä–æ–Ω—è +1 DEF [500 A]</button>
                <button id="upgradeSpd" class="shop-btn" style="background: #004400; border-color:#00ff88;">FARM SPD (+5%) [10 C]</button>
            </div>
            <div style="display:flex; justify-content: space-around; margin-top:5px;">
                <button id="buyHpReg" class="shop-btn" style="background:#550000; border-color:#ff0000;">HP REG (+1/s) [10 M]</button>
                <button id="upgradeCrystal" class="shop-btn" style="background: #000055; border-color:#0000ff;">CRYSTAL UP (+5%) [15 M]</button>
                <button id="upgradeSpoil" class="shop-btn" style="background: #555500; border-color:#ffff00;">SPOIL UP (+5%) [15 C]</button>
            </div>
            </div>
        <div id="log"></div>
    </div>
  </div>

  <script>
    // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï ===
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const logEl = document.getElementById('log');
    
    let entities = [];
    let player, pet = { 
        level:1, exp:0, expToNext:100, 
        spoilLevel:1, spoilExp:0, spoilToNext:100, 
        adena:0, crystals:0, mats:0,
        weaponLevel: 0, armorLevel: 0,
        crystalChanceLevel: 0,
        spoilBonusLevel: 0, // –£—Ä–æ–≤–µ–Ω—å –±–æ–Ω—É—Å–∞ —Å–ø–æ–π–ª–∞ (–∑–∞–º–µ–Ω—è–µ—Ç –≥–Ω–æ–º–æ–≤)
        farmSpeedLevel: 0, // –£—Ä–æ–≤–µ–Ω—å —Å–∫–æ—Ä–æ—Å—Ç–∏ –∞—Ç–∞–∫–∏
        hpRegenRate: 0, // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è HP
    };
    let camera = { x:0, y:0, targetX: 0, targetY: 0 };
    let selectedTarget = null;
    let mobSpawnInterval;
    let regTick = 0; // –¢–∏–∫ –¥–ª—è —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    
    // NPC —É–¥–∞–ª–µ–Ω—ã, –≤—Å–µ –±–æ–Ω—É—Å—ã —Ç–µ–ø–µ—Ä—å –¥–ª—è –∏–≥—Ä–æ–∫–∞
    
    const CONFIG = {
      ROOM_SIZE: 320,
      ATTACK_RANGE: 300, // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–¥–∏—É—Å –∞—Ç–∞–∫–∏ –¥–ª—è Essence
      ATTACK_SPEED_BASE: 1000, // –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∞—Ç–∞–∫–∏ (–º—Å)
      SPEED_REDUCTION_PER_LEVEL: 0.05, // 5% —É–º–µ–Ω—å—à–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
      SPOIL_CHANCE_BASE: 0.35, 
      CHANCE_PER_SPOIL_LEVEL: 0.05, 
      CRYSTAL_CHANCE_BASE: 0.10, 
      CRYSTAL_CHANCE_PER_LEVEL: 0.05,
      MOB_RESPAWN_TIME: 4000, // –£—Å–∫–æ—Ä–µ–Ω–Ω—ã–π —Ä–µ—Å–ø–∞—É–Ω
      ZOOM: 1.7,
      CAMERA_SMOOTHING: 0.05,
    };
    
    // === –°–¢–û–ò–ú–û–°–¢–¨ –ú–ê–ì–ê–ó–ò–ù–ê ===
    const SHOP_COST = {
        WEAPON_BASE_A: 500,
        ARMOR_BASE_A: 500,
        FARM_SPEED_C: 10,
        HP_REGEN_M: 10,
        CRYSTAL_CHANCE_M: 15,
        SPOIL_CHANCE_C: 15
    };

    // === –†–ï–°–ê–ô–ó –∏ –£–î–ê–õ–ï–ù–ò–ï –î–ñ–û–ô–°–¢–ò–ö–ê ===
    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = canvas.clientHeight; 
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
    }
    window.addEventListener('resize', resize);
    resize();
    
    // === –ê–í–¢–û–ö–†–ò–°–¢–ê–õ–õ–ò–ó–ê–¶–ò–Ø (—Ç–µ–ø–µ—Ä—å –≥–ª–æ–±–∞–ª—å–Ω–∞—è, –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –≥–Ω–æ–º–∞–º) ===
    function autoCrystallize() {
        if (pet.mats <= 0) return;
        
        const chance = CONFIG.CRYSTAL_CHANCE_BASE + pet.crystalChanceLevel * CONFIG.CRYSTAL_CHANCE_PER_LEVEL;
        
        pet.mats--; 
        if (Math.random() < chance) {
            pet.crystals += 1; 
            log(`[CRYSTAL] +1 C`, '#00ffff');
        } 
        checkLevel();
    }
    
    // === –¢–ò–ö –†–ï–ì–ï–ù–ï–†–ê–¶–ò–ò ===
    function regenerationTick() {
        if (player && player.hp > 0 && pet.hpRegenRate > 0) {
            player.heal(pet.hpRegenRate * 1); // 1 —Ç–∏–∫ = 1 —Å–µ–∫—É–Ω–¥–∞
        }
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏—è (–Ω–∞ –∫–∞–∂–¥–æ–º —Ç–∏–∫–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ç-–ª—ã)
        if (pet.mats > 0) {
             autoCrystallize();
        }
    }
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∏–∫ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    setInterval(regenerationTick, 1000); 

    // === –ö–õ–ê–°–°–´ ===
    class Unit {
      constructor(x, y, type, symbol, color, hp, str, def, mobLvl=1) {
        this.x = x; this.y = y; this.type = type; this.symbol = symbol;
        this.color = color; this.hp = hp; this.maxHp = hp;
        this.baseStr = str; this.baseDef = def; 
        this.mobLvl = mobLvl; 
        this.target = null;
        this.spoiled = false; 
        this.lastAttack = 0; // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞—Ç–∞–∫–∏
        entities.push(this);
      }
      
      get str() {
          if (this.type === 'player') return this.baseStr + pet.weaponLevel;
          return this.baseStr;
      }
      
      get def() {
          if (this.type === 'player') return this.baseDef + pet.armorLevel;
          return this.baseDef;
      }
      
      distTo(t) { return Math.hypot(this.x - t.x, this.y - t.y); }
      
      // –í Essence –Ω–µ—Ç –¥–≤–∏–∂–µ–Ω–∏—è
      moveTo(tx, ty, s) { return true; } 
      
      attack(t) {
        const now = Date.now();
        let attackDelay = CONFIG.ATTACK_SPEED_BASE;
        
        if (this.type === 'player') {
             // –°–∫–æ—Ä–æ—Å—Ç—å —Ñ–∞—Ä–º–∞: —É–º–µ–Ω—å—à–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É
             attackDelay *= (1 - pet.farmSpeedLevel * CONFIG.SPEED_REDUCTION_PER_LEVEL);
        }

        if (!t || t.hp <= 0 || this.distTo(t) > CONFIG.ATTACK_RANGE || now - this.lastAttack < attackDelay) return;
        
        this.lastAttack = now;

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π Spoil –ø—Ä–∏ –∞—Ç–∞–∫–µ
        if (this.type === 'player') {
            this.autoSpoil(t);
        }
        
        const dmg = Math.max(1, this.str - t.def + (Math.random()*3|0)); 
        t.hp -= dmg;
        log(`${this.symbol} ‚Üí ${t.symbol}: -${dmg}`, this.color);
        
        if (t.hp <= 0) { 
            this.onKill(t); 
            t.die(); 
            this.target = null;
        }
      }
      
      autoSpoil(t) {
        if (t.spoiled || t.type !== 'mob' || t.hp <= 0) return;
        
        const globalSpoilBonus = pet.spoilBonusLevel * CONFIG.CHANCE_PER_SPOIL_LEVEL;
        const chance = CONFIG.SPOIL_CHANCE_BASE + (pet.spoilLevel-1) * CONFIG.CHANCE_PER_SPOIL_LEVEL + globalSpoilBonus;
        
        if (Math.random() < chance) {
          t.spoiled = true;
          log(`[SPOIL] –£–°–ü–ï–•: –¶–µ–ª—å –ø–æ–º–µ—á–µ–Ω–∞.`, '#ffd700');
          addEffect(t.x, t.y, `SPOIL!`);
        }
      }
      
      autoSweep(t) {
          if (t.type !== 'mob' || !t.spoiled || t.hp > 0) return;
          
          const chance = CONFIG.SPOIL_CHANCE_BASE + (pet.spoilLevel-1) * CONFIG.CHANCE_PER_SPOIL_LEVEL;
          
          if (Math.random() < chance) {
              let dropType, amount;
              
              if (Math.random() < 0.5) { 
                  dropType = 'Crystal: D';
                  amount = 1 + (Math.random()*4|0);
                  pet.crystals += amount;
              } else {
                  const items = ['Animal Bone', 'Iron Ore', 'Craft Leather', 'Bone Dust'];
                  dropType = items[Math.floor(Math.random()*items.length)];
                  amount = 2 + (Math.random()*5|0);
                  pet.mats += amount;
              }
              
              log(`[SWEEP] +${dropType} x${amount}`, '#00ff00');
              addEffect(t.x, t.y, `+${dropType}`);
              
              pet.spoilExp += 20 * amount; 
              checkLevel();
          } else {
              log(`[SWEEP] –ü–†–û–í–ê–õ. –õ—É—Ç –ø–æ—Ç–µ—Ä—è–Ω.`, '#ff0000');
          }
      }

      onKill(t) {
        if (t.spoiled) {
             this.autoSweep(t);
        } else {
             // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥—Ä–æ–ø, —á—Ç–æ–±—ã —Ñ–∞—Ä–º –±—ã–ª –±—ã—Å—Ç—Ä—ã–º
             pet.adena += 100 + (Math.random()*150|0);
             pet.exp += 30;
        }
        checkLevel();
      }
      
      die() {
        if (this.type === 'player') { /* ... */ }
        
        if (selectedTarget === this) selectedTarget = null;
        
        if (this.type === 'mob') {
            entities = entities.filter(e => e !== this);
            const room = this.getRoom();
            setTimeout(() => spawnMob(room), CONFIG.MOB_RESPAWN_TIME);
        }
      }
      
      getRoomCenter(r) {
        const rx = r % 2, ry = Math.floor(r / 2);
        return { x: rx * CONFIG.ROOM_SIZE + CONFIG.ROOM_SIZE/2, y: ry * CONFIG.ROOM_SIZE + CONFIG.ROOM_SIZE/2 };
      }

      aiTick() {
        if (this.hp <= 0) return;
        
        // –¢–æ–ª—å–∫–æ –º–æ–±—ã –∞—Ç–∞–∫—É—é—Ç
        if (this.type === 'mob') {
          // –ú–æ–± –∏—â–µ—Ç –±–ª–∏–∂–∞–π—à–µ–≥–æ –∏–≥—Ä–æ–∫–∞
          const nearest = entities.find(e => e.type === 'player' && dist(this, e) < CONFIG.ATTACK_RANGE * 2);
          if (nearest) this.target = nearest;

          if (this.target) {
            this.attack(this.target);
          }
        }
      }
    }

    class Player extends Unit {
      constructor() { 
          super(160, 160, 'player', '‚öíÔ∏è', '#ff6b6b', 250, 16, 9, 0); 
          this.maxHp = 250;
      }
      
      heal(amount) { 
          this.hp = Math.min(this.maxHp, this.hp + amount); 
          // log(`–õ–µ—á–µ–Ω–∏–µ +${Math.round(amount)} HP.`, '#44ff44'); 
      }
      
      update() {
        // –ü–µ—Ä—Å–æ–Ω–∞–∂ –≤—Å–µ–≥–¥–∞ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –≤ —Ü–µ–Ω—Ç—Ä —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã (Essence style)
        const room = Math.floor(this.x / CONFIG.ROOM_SIZE) + Math.floor(this.y / CONFIG.ROOM_SIZE) * 2;
        const center = this.getRoomCenter(room);
        this.x = center.x;
        this.y = center.y;

        // 1. –ê–í–¢–û-–§–ê–†–ú –õ–û–ì–ò–ö–ê (–í–°–ï–ì–î–ê –ê–ö–¢–ò–í–ù–ê)
        // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –∂–∏–≤—É—é —Ü–µ–ª—å –≤ —Ä–∞–¥–∏—É—Å–µ
        if (!selectedTarget || selectedTarget.hp <= 0) {
            selectedTarget = entities
                .filter(e => e.type === 'mob' && e.hp > 0)
                .sort((a,b) => dist(player,a) - dist(player,b))[0];
        } else if (selectedTarget && selectedTarget.hp <= 0) {
            selectedTarget = null;
        }

        // 2. –ê—Ç–∞–∫–∞ –ø–æ —Ü–µ–ª–∏ (–µ—Å–ª–∏ –æ–Ω–∞ –≤ —Ä–∞–¥–∏—É—Å–µ)
        if (selectedTarget && selectedTarget.hp > 0) {
            this.attack(selectedTarget);
        }
      }
    }

    // === –§–£–ù–ö–¶–ò–ò ===
    function addEffect(x, y, text) { /* ... */ }
    function dist(a,b) { return Math.hypot(a.x-b.x, a.y-b.y); }
    function log(msg, color='#fff') {
      const d = document.createElement('div');
      d.textContent = msg;
      d.style.color = color;
      logEl.prepend(d);
      while (logEl.children.length > 30) { logEl.removeChild(logEl.lastChild); }
    }

    // === CHECKLEVEL & UI UPDATE ===
    function checkLevel() {
      if (pet.exp >= pet.expToNext) { 
        pet.level++; 
        pet.exp = pet.exp - pet.expToNext;
        pet.expToNext = Math.floor(pet.expToNext * 1.5 + 100); 
        player.maxHp = Math.floor(player.maxHp * 1.2); // –ë—ã—Å—Ç—Ä—ã–π —Ä–æ—Å—Ç HP
        player.heal(player.maxHp);
        log(`–£–†–û–í–ï–ù–¨ ${pet.level} UP! HP Max: ${player.maxHp}`, '#00ff00'); 
      }
      if (pet.spoilExp >= pet.spoilToNext) { 
        pet.spoilLevel++; 
        pet.spoilExp = pet.spoilExp - pet.spoilToNext; 
        pet.spoilToNext = Math.floor(pet.spoilToNext * 1.5 + 50); 
        log(`–°–ü–û–ô–õ –£–†–û–í–ï–ù–¨ ${pet.spoilLevel} UP!`, '#ffd700'); 
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
      document.getElementById('level').textContent = pet.level;
      document.getElementById('str').textContent = player.str;
      document.getElementById('def').textContent = player.def;
      document.getElementById('expBar').style.width = (pet.exp / pet.expToNext * 100) + '%';
      
      document.getElementById('spoilLevel').textContent = pet.spoilLevel;
      document.getElementById('spoilBar').style.width = (pet.spoilExp / pet.spoilToNext * 100) + '%';
      
      document.getElementById('adena').textContent = pet.adena;
      document.getElementById('crystals').textContent = pet.crystals;
      document.getElementById('mats').textContent = pet.mats;
      
      document.getElementById('allySpoilBonus').textContent = (pet.spoilBonusLevel * CONFIG.CHANCE_PER_SPOIL_LEVEL * 100) + '%';
      document.getElementById('hpReg').textContent = pet.hpRegenRate;
      document.getElementById('crystalChance').textContent = (CONFIG.CRYSTAL_CHANCE_BASE * 100 + pet.crystalChanceLevel * CONFIG.CRYSTAL_CHANCE_PER_LEVEL * 100) + '%';
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ HP-–±–∞—Ä–∞ –∏ —Ü–µ–Ω
      const hpWidth = (player.hp / player.maxHp * 100);
      canvas.style.boxShadow = `0 0 30px ${hpWidth < 20 ? '#ff0000' : '#330000'} inset`;
      
      document.getElementById('buyWeapon').textContent = `–û—Ä—É–∂–∏–µ +${pet.weaponLevel+1} [${SHOP_COST.WEAPON_BASE_A * (pet.weaponLevel + 1)} A]`;
      document.getElementById('buyArmor').textContent = `–ë—Ä–æ–Ω—è +${pet.armorLevel+1} [${SHOP_COST.ARMOR_BASE_A * (pet.armorLevel + 1)} A]`;
      document.getElementById('upgradeSpd').textContent = `FARM SPD (+${pet.farmSpeedLevel+1}%) [${SHOP_COST.FARM_SPEED_C * (pet.farmSpeedLevel + 1)} C]`;
      document.getElementById('buyHpReg').textContent = `HP REG (+1/s) [${SHOP_COST.HP_REGEN_M * (pet.hpRegenRate + 1)} M]`;
    }
    
    function checkSpoil() { checkLevel(); } 
    function reset() { /* ... */ init(); }

    // === –ò–ù–ò–¢ & –°–ü–ê–í–ù ===
    function init() {
      entities = [];
      player = new Player();
      
      // –ù–∞—á–∏–Ω–∞–µ–º –≤ —Ü–µ–Ω—Ç—Ä–µ –ø–µ—Ä–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã
      const c = player.getRoomCenter(0);
      player.x = c.x;
      player.y = c.y;
      
      for (let i = 0; i < 4; i++) {
        const mobLvl = 10 + i * 5; 
        for (let j = 0; j < 5; j++) spawnMob(i, mobLvl); // –ë–æ–ª—å—à–µ –º–æ–±–æ–≤
      }
      
      if (mobSpawnInterval) clearInterval(mobSpawnInterval);
      mobSpawnInterval = setInterval(spawnMob, CONFIG.MOB_RESPAWN_TIME);
      
      checkLevel();
    }

    function spawnMob(room = Math.floor(Math.random()*4), mobLvl = 10 + room * 5) {
      const mobsInRoom = entities.filter(e => e.type === 'mob' && e.getRoom() === room).length;
      if (mobsInRoom >= 7) return; 

      const c = player.getRoomCenter(room);
      new Unit(
        c.x + Math.random()*150-75, // –ë–æ–ª—å—à–∏–π —Ä–∞–∑–±—Ä–æ—Å –º–æ–±–æ–≤
        c.y + Math.random()*150-75, 
        'mob', 
        Math.random() > 0.5 ? 'üíÄ' : 'üëπ', 
        '#ff4444', 
        90 + mobLvl*5, 
        9 + Math.floor(mobLvl/5), 
        5 + Math.floor(mobLvl/10), 
        mobLvl
      );
    }

    // === –õ–û–ì–ò–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê ===
    document.getElementById('buyWeapon').addEventListener('click', () => {
        const cost = SHOP_COST.WEAPON_BASE_A * (pet.weaponLevel + 1);
        if (pet.adena >= cost) {
            pet.adena -= cost;
            pet.weaponLevel++;
            log(`–ö—É–ø–ª–µ–Ω–æ: –û—Ä—É–∂–∏–µ +${pet.weaponLevel}. STR: +1`, '#ff6b6b');
            checkLevel();
        } else { log(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–¥–µ–Ω—ã (–Ω—É–∂–Ω–æ ${cost} A)!`, '#ff0000'); }
    });

    document.getElementById('buyArmor').addEventListener('click', () => {
        const cost = SHOP_COST.ARMOR_BASE_A * (pet.armorLevel + 1);
        if (pet.adena >= cost) {
            pet.adena -= cost;
            pet.armorLevel++;
            log(`–ö—É–ø–ª–µ–Ω–æ: –ë—Ä–æ–Ω—è +${pet.armorLevel}. DEF: +1`, '#00ff88');
            checkLevel();
        } else { log(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–¥–µ–Ω—ã (–Ω—É–∂–Ω–æ ${cost} A)!`, '#ff0000'); }
    });
    
    // –£–ª—É—á—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ñ–∞—Ä–º–∞ (Attack Speed)
    document.getElementById('upgradeSpd').addEventListener('click', () => {
        const cost = SHOP_COST.FARM_SPEED_C * (pet.farmSpeedLevel + 1);
        if (pet.crystals >= cost) {
            pet.crystals -= cost;
            pet.farmSpeedLevel++;
            log(`–°–∫–æ—Ä–æ—Å—Ç—å —Ñ–∞—Ä–º–∞ +${pet.farmSpeedLevel}!`, '#00ff88');
            checkLevel();
        } else { log(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—É–¥—Ä (–Ω—É–∂–Ω–æ ${cost} C)!`, '#ff0000'); }
    });

    // –£–ª—É—á—à–µ–Ω–∏–µ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HP
    document.getElementById('buyHpReg').addEventListener('click', () => {
        const cost = SHOP_COST.HP_REGEN_M * (pet.hpRegenRate + 1);
        if (pet.mats >= cost) {
            pet.mats -= cost;
            pet.hpRegenRate++;
            log(`–†–µ–≥–µ–Ω HP +1/s!`, '#ff0000');
            checkLevel();
        } else { log(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–Ω—É–∂–Ω–æ ${cost} M)!`, '#ff0000'); }
    });
    
    // –£–ª—É—á—à–µ–Ω–∏–µ —à–∞–Ω—Å–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏–∏
    document.getElementById('upgradeCrystal').addEventListener('click', () => {
        const cost = SHOP_COST.CRYSTAL_CHANCE_M;
        if (pet.mats >= cost) {
            pet.mats -= cost;
            pet.crystalChanceLevel++; 
            log(`–®–∞–Ω—Å –∫—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏–∏ —É–≤–µ–ª–∏—á–µ–Ω!`, '#00ffff');
            checkLevel();
        } else { log(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–Ω—É–∂–Ω–æ ${cost} M)!`, '#ff0000'); }
    });

    // –£–ª—É—á—à–µ–Ω–∏–µ —à–∞–Ω—Å–∞ Spoil
    document.getElementById('upgradeSpoil').addEventListener('click', () => {
        const cost = SHOP_COST.SPOIL_CHANCE_C * (pet.spoilBonusLevel + 1);
        if (pet.crystals >= cost) {
            pet.crystals -= cost;
            pet.spoilBonusLevel++; 
            log(`–®–∞–Ω—Å Spoil —É–≤–µ–ª–∏—á–µ–Ω!`, '#ffd700');
            checkLevel();
        } else { log(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—É–¥—Ä (–Ω—É–∂–Ω–æ ${cost} C)!`, '#ff0000'); }
    });
    
    // === –†–ï–ù–î–ï–† & –õ–£–ü ===
    function render() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.save();
      
      // –ö–∞–º–µ—Ä–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –∏–≥—Ä–æ–∫–µ (–∫–æ—Ç–æ—Ä—ã–π –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è)
      ctx.translate(-camera.x * CONFIG.ZOOM, -camera.y * CONFIG.ZOOM);
      ctx.scale(CONFIG.ZOOM, CONFIG.ZOOM);

      // –ö–∞—Ä—Ç–∞
      ctx.fillStyle = '#222';
      ctx.fillRect(0,0,CONFIG.ROOM_SIZE*2,CONFIG.ROOM_SIZE*2);
      ctx.strokeStyle = '#555';
      ctx.lineWidth = 4;
      for (let i=0; i<=2; i++) {
        ctx.beginPath();
        ctx.moveTo(i*CONFIG.ROOM_SIZE, 0);
        ctx.lineTo(i*CONFIG.ROOM_SIZE, CONFIG.ROOM_SIZE*2);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, i*CONFIG.ROOM_SIZE);
        ctx.lineTo(CONFIG.ROOM_SIZE*2, i*CONFIG.ROOM_SIZE);
        ctx.stroke();
      }

      // –Æ–Ω–∏—Ç—ã
      entities.forEach(e => {
        if (e.hp <= 0) return; 

        // 1. –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–ª–∏
        if (e === selectedTarget) {
          ctx.strokeStyle = '#ffff00';
          ctx.lineWidth = 3;
          ctx.beginPath(); ctx.arc(e.x, e.y, 25, 0, Math.PI*2); ctx.stroke();
        }
        
        // 2. –°–∏–º–≤–æ–ª
        ctx.font = '36px Arial';
        ctx.fillText(e.symbol, e.x, e.y + 2);
        
        // 3. –ü–æ–ª–æ—Å–∞ HP
        if (e.hp > 0) {
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(e.x-22, e.y-35, 44, 6);
            ctx.fillStyle = '#44ff44';
            ctx.fillRect(e.x-22, e.y-35, 44*(e.hp/e.maxHp), 6);
        }
        
        // 4. –ú–µ—Ç–∫–∞ Spoiled
        if (e.spoiled) {
           ctx.fillStyle = '#ffd700';
           ctx.font = '10px Arial';
           ctx.fillText('SPOIL', e.x, e.y - 40);
        }
        
        // 5. –¢–µ–∫—É—â–∏–µ —Å—Ç–∞—Ç—ã
        ctx.fillStyle = '#fff';
        ctx.font = '8px Arial';
        const statText = `L${e.mobLvl || e.level} STR:${e.str} DEF:${e.def}`;
        ctx.fillText(statText, e.x, e.y - 45);
      });

      ctx.restore();
    }

    function updateCamera() {
      // –ö–∞–º–µ—Ä–∞ –≤—Å–µ–≥–¥–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –∏–≥—Ä–æ–∫–µ
      camera.targetX = player.x - canvas.width/(2*CONFIG.ZOOM);
      camera.targetY = player.y - canvas.height/(2*CONFIG.ZOOM);
      
      camera.x += (camera.targetX - camera.x) * CONFIG.CAMERA_SMOOTHING;
      camera.y += (camera.targetY - camera.y) * CONFIG.CAMERA_SMOOTHING;
      
      const maxCamX = CONFIG.ROOM_SIZE*2 - canvas.width/CONFIG.ZOOM;
      const maxCamY = CONFIG.ROOM_SIZE*2 - canvas.height/CONFIG.ZOOM;
      
      camera.x = Math.max(0, Math.min(camera.x, maxCamX));
      camera.y = Math.max(0, Math.min(camera.y, maxCamY));
    }

    function loop() {
      player.update();
      entities.forEach(e => { if (e !== player) e.aiTick(); });
      updateCamera();
      render();
      requestAnimationFrame(loop);
    }
    
    // === –û–ë–†–ê–ë–û–¢–ö–ê –ö–õ–ò–ö–ê (–¢–æ–ª—å–∫–æ –¥–ª—è —Å–º–µ–Ω—ã —Ü–µ–ª–∏) ===
    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const tx = (e.touches[0].clientX - rect.left) / CONFIG.ZOOM + camera.x;
      const ty = (e.touches[0].clientY - rect.top) / CONFIG.ZOOM + camera.y;
      
      // –ö–ª–∏–∫ —Å–º–µ–Ω—è–µ—Ç —Ü–µ–ª—å
      selectedTarget = entities.find(ent => ent !== player && ent.hp > 0 && dist(ent, {x:tx, y:ty}) < 40);
    });

    init();
    loop();
  </script>
</body>
</html>
