<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>L2 C4: –°–ø–æ–π–ª–µ—Ä –ö–∞—Ç–∞–∫–æ–º–± (–£–ª—É—á—à–µ–Ω–æ)</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0a;
      --wall: #222;
      --floor: #111;
      --gold: #ffd700;
      --red: #ff4444;
      --green: #44ff44;
      /* –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É UI –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∂–æ–π—Å—Ç–∏–∫–∞ */
      --ui-height: 180px; 
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: var(--bg);
      color: #ffcc80;
      font-family: 'Press Start 2P', cursive;
      overflow: hidden;
      user-select: none;
      touch-action: none;
    }
    #game { 
      display: flex; 
      flex-direction: column; 
      height: 100vh; 
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }
    canvas {
      image-rendering: pixelated;
      background: var(--floor);
      box-shadow: 0 0 30px #330000 inset;
      flex-grow: 1; /* –ü–æ–∑–≤–æ–ª—è–µ—Ç Flexbox —É–ø—Ä–∞–≤–ª—è—Ç—å –≤—ã—Å–æ—Ç–æ–π */
    }
    #ui-container {
      display: flex;
      flex-direction: column;
      height: var(--ui-height);
    }
    #ui {
      padding: 15px;
      background: #111;
      border-top: 3px solid #444;
      font-size: 12px;
      flex-shrink: 0;
    }
    #log {
      height: 100%; /* –£–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è Flexbox */
      overflow-y: auto;
      background: #000;
      padding: 10px;
      border: 2px solid #444;
      margin-top: 10px;
      border-radius: 8px;
      font-size: 11px;
      color: #ccc;
      flex-grow: 1;
    }

    .bar {
      height: 20px;
      background: #222;
      border: 2px solid #555;
      margin: 10px 0;
      border-radius: 10px;
      overflow: hidden;
    }
    .fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b6b, #feca57, #a0e7a0);
      border-radius: 8px;
      transition: width 0.4s ease;
    }
    .label {
      margin: 8px 0 4px;
      color: #ffcc80;
      display: flex;
      justify-content: space-between;
    }
    
    h1 {
      font-size: 16px;
      color: #ff6b6b;
      text-align: center;
      margin-bottom: 10px;
      text-shadow: 0 0 10px #ff0000;
    }

    /* –î–ñ–û–ô–°–¢–ò–ö - –ü–æ–¥–Ω—è—Ç –Ω–∞–¥ UI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º */
    #joystick {
      position: absolute;
      left: 20px; 
      bottom: calc(20px + var(--ui-height));
      width: 130px; height: 130px;
      background: rgba(100,100,100,0.3);
      border: 4px solid #666;
      border-radius: 50%;
      z-index: 100;
    }
    #knob {
      position: absolute;
      width: 55px; height: 55px;
      background: radial-gradient(circle at 30% 30%, #ff6b6b, #cc0000);
      border-radius: 50%;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 20px #ff0000;
      transition: all 0.05s;
    }

    /* –°–ü–û–ô–õ - –ü–æ–¥–Ω—è—Ç –Ω–∞–¥ UI-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º */
    #spoilBtn {
      position: absolute;
      right: 20px; 
      bottom: calc(20px + var(--ui-height));
      width: 100px; height: 100px;
      background: radial-gradient(circle, #ffd700, #cc9900);
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #000;
      font-weight: bold;
      box-shadow: 0 0 25px #ff0;
      z-index: 100;
    }
    #spoilBtn:active { transform: scale(0.85); }

    .spoil-effect {
      position: absolute;
      color: #ffd700;
      font-weight: bold;
      pointer-events: none;
      animation: float 1s ease-out forwards;
      z-index: 50;
    }
    @keyframes float {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-50px); opacity: 0; }
    }
  </style>
</head>
<body>
  <div id="game">
    <canvas id="canvas"></canvas>

    <div id="joystick"><div id="knob"></div></div>
    <div id="spoilBtn">
      <div style="font-size:18px">‚ú®</div>
      –°–ü–û–ô–õ
    </div>

    <div id="ui-container">
        <div id="ui">
            <h1>L2 C4: –ö–ê–¢–ê–ö–û–ú–ë–´</h1>
            <div class="label">–£—Ä–æ–≤–µ–Ω—å: <span id="level">1</span></div>
            <div class="bar"><div id="expBar" class="fill" style="width:0%"></div></div>

            <div class="label">–°–ø–æ–π–ª: <span id="spoilLevel">1</span> | –ü—É–¥—Ä—ã: <span id="crystals">0</span></div>
            <div class="bar"><div id="spoilBar" class="fill" style="width:0%"></div></div>

            <div class="label">–ê–¥–µ–Ω: <span id="adena">0</span> | –ú–∞—Ç-–ª—ã: <span id="mats">0</span></div>
        </div>
        <div id="log"></div>
    </div>
  </div>

  <script>
    // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï ===
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const logEl = document.getElementById('log');
    let entities = [];
    let player, pet = { level:1, exp:0, expToNext:100, spoilLevel:1, spoilExp:0, spoilToNext:100, adena:0, crystals:0, mats:0 };
    let camera = { x:0, y:0, targetX: 0, targetY: 0 }; // –î–æ–±–∞–≤–ª–µ–Ω—ã —Ü–µ–ª–µ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    let joystick = { active:false, dx:0, dy:0 };
    let selectedTarget = null;
    let mobSpawnInterval;

    const CONFIG = {
      ROOM_SIZE: 320,
      ATTACK_RANGE: 85,
      SPOIL_RANGE: 120, // –ù–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–µ–Ω —Ä–∞–¥–∏—É—Å –¥–ª—è —Å–ø–æ–π–ª–∞
      MOVE_SPEED: 4.2,
      SPOIL_CHANCE: 0.32,
      SPOIL_BONUS: 0.09,
      MOB_RESPAWN_TIME: 8000,
      GOAL_ADENA: 10000,
      ZOOM: 1.7,
      CAMERA_SMOOTHING: 0.05 // –ü–ª–∞–≤–Ω–æ—Å—Ç—å —Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∫–∞–º–µ—Ä—ã
    };

    // === –†–ï–°–ê–ô–ó ===
    function resize() {
      canvas.width = window.innerWidth;
      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è JS-—Ä–∞–∑–º–µ—Ä–∞ —Å CSS-—Ä–∞–∑–º–µ—Ä–æ–º, –∑–∞–¥–∞–Ω–Ω—ã–º Flexbox
      canvas.height = canvas.clientHeight; 
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –¥–ª—è —é–Ω–∏—Ç–æ–≤
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
    }
    window.addEventListener('resize', resize);
    resize();

    // === –î–ñ–û–ô–°–¢–ò–ö ===
    // ... (–∫–æ–¥ –¥–∂–æ–π—Å—Ç–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –æ–Ω –±—ã–ª –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω)

    const joy = document.getElementById('joystick');
    const knob = document.getElementById('knob');
    let joyCenter = {};

    joy.addEventListener('touchstart', e => {
      e.preventDefault();
      joystick.active = true;
      const r = joy.getBoundingClientRect();
      joyCenter = { x: r.left + r.width/2, y: r.top + r.height/2 };
      updateJoy(e.touches[0]);
    });
    joy.addEventListener('touchmove', e => updateJoy(e.touches[0]));
    joy.addEventListener('touchend', () => {
      joystick.active = false;
      joystick.dx = joystick.dy = 0;
      knob.style.transform = 'translate(-50%, -50%)';
    });

    function updateJoy(t) {
      if (!joystick.active) return;
      const dx = t.clientX - joyCenter.x;
      const dy = t.clientY - joyCenter.y;
      const dist = Math.min(60, Math.hypot(dx, dy));
      const angle = Math.atan2(dy, dx);
      joystick.dx = Math.cos(angle) * dist / 60;
      joystick.dy = Math.sin(angle) * dist / 60;
      knob.style.transform = `translate(${dx * 0.7}px, ${dy * 0.7}px)`;
    }

    // === –°–ü–û–ô–õ ===
    document.getElementById('spoilBtn').addEventListener('touchstart', e => {
      e.preventDefault();
      // –í—ã–±–∏—Ä–∞–µ–º –±–ª–∏–∂–∞–π—à—É—é —Ü–µ–ª—å, –µ—Å–ª–∏ –Ω–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∏–ª–∏ –æ–Ω–∞ –º–µ—Ä—Ç–≤–∞
      if (!selectedTarget || selectedTarget.hp <= 0) {
        selectedTarget = entities
          .filter(e => e.type === 'mob' && e.hp > 0 && dist(player, e) < 500)
          .sort((a,b) => dist(player,a) - dist(player,b))[0];
      }
      
      // –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ SPOIL
      if (selectedTarget && !selectedTarget.spoiled && dist(player, selectedTarget) < CONFIG.SPOIL_RANGE) {
        player.spoil(selectedTarget);
      } else if (selectedTarget && selectedTarget.hp > 0 && selectedTarget.spoiled) {
         log(`–¶–µ–ª—å —É–∂–µ —Å–ø–æ–π–ª–µ–Ω–∞!`, '#888');
      } else if (selectedTarget && dist(player, selectedTarget) >= CONFIG.SPOIL_RANGE) {
         log(`–°–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –¥–ª—è —Å–ø–æ–π–ª–∞!`, '#888');
      } else {
         log(`–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–π —Ü–µ–ª–∏.`, '#888');
      }
    });

    // === –ö–õ–ê–°–°–´ ===
    class Unit {
      constructor(x, y, type, symbol, color, hp, str, def) {
        this.x = x; this.y = y; this.type = type; this.symbol = symbol;
        this.color = color; this.hp = hp; this.maxHp = hp;
        this.str = str; this.def = def; this.target = null;
        this.spoiled = false; this.allianceId = Math.random() > 0.5 ? 1 : 2;
        this.bravery = type === 'gnome' ? Math.random() : 0.7;
        entities.push(this);
      }
      distTo(t) { return Math.hypot(this.x - t.x, this.y - t.y); }
      moveTo(tx, ty, s) {
        const dx = tx - this.x, dy = ty - this.y;
        const d = Math.hypot(dx, dy);
        if (d < s) { 
           this.x = tx; 
           this.y = ty; 
           return true; // –î–æ—Å—Ç–∏–≥ —Ü–µ–ª–∏
        }
        this.x += (dx/d) * s;
        this.y += (dy/d) * s;
        return false; // –ï—â–µ –¥–≤–∏–∂–µ—Ç—Å—è
      }
      attack(t) {
        if (!t || t.hp <= 0 || this.distTo(t) > CONFIG.ATTACK_RANGE) return;
        
        // –£–±—Ä–∞–Ω–æ Math.random()*5|0 –¥–ª—è –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–≥–æ —É—Ä–æ–Ω–∞
        const dmg = Math.max(1, this.str - t.def + (Math.random()*3|0)); 
        t.hp -= dmg;
        log(`${this.symbol} ‚Üí ${t.symbol}: -${dmg}`, this.color);
        
        if (t.hp <= 0) { 
            this.onKill(t); 
            t.die(); 
            this.target = null; // –°–±—Ä–æ—Å —Ü–µ–ª–∏ –ø–æ—Å–ª–µ —É–±–∏–π—Å—Ç–≤–∞
        }
      }
      spoil(t) {
        // –£–≤–µ–ª–∏—á–µ–Ω–∞ –¥–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –∫–Ω–æ–ø–∫–æ–π
        if (t.spoiled || t.type !== 'mob' || this.distTo(t) > CONFIG.SPOIL_RANGE) return; 
        
        const chance = CONFIG.SPOIL_CHANCE + (pet.spoilLevel-1)*CONFIG.SPOIL_BONUS;
        
        if (Math.random() < chance) {
          t.spoiled = true;
          const items = ['Animal Bone', 'Iron Ore', 'Craft Leather', 'Bone Dust', 'Crystal: D'];
          const item = items[Math.floor(Math.random()*items.length)];
          const amt = 1 + (Math.random()*2|0);
          if (item.includes('Crystal')) pet.crystals += amt;
          else pet.mats += amt;
          log(`SPOIL +${item} x${amt}`, '#ffd700');
          addEffect(t.x, t.y, `+${item}`);
          pet.spoilExp += 12 * amt;
          checkSpoil();
        } else {
          log('–ü—Ä–æ–≤–∞–ª...', '#888');
        }
      }
      onKill(t) {
        pet.adena += 60 + (Math.random()*80|0);
        pet.exp += 18;
        checkLevel();
        if (t.spoiled) { pet.adena += 120; log('+120 –∞–¥–µ–Ω!', '#ffcc80'); }
      }
      die() {
        if (this.type === 'player') {
          log('–¢–´ –£–ú–ï–†!', '#ff0000');
          pet.adena = Math.floor(pet.adena * 0.5);
          setTimeout(reset, 2000);
          return;
        }
        // –°–±—Ä–æ—Å —Ü–µ–ª–∏, –µ—Å–ª–∏ —É–±–∏—Ç—ã–π —é–Ω–∏—Ç –±—ã–ª —Ü–µ–ª—å—é
        if (selectedTarget === this) selectedTarget = null;
        // –£–±–∏—Ä–∞–µ–º —é–Ω–∏—Ç –∏–∑ —Å–ø–∏—Å–∫–∞
        entities = entities.filter(e => e !== this);
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–µ—Å–ø–∞—É–Ω –º–æ–±–∞ (–µ—Å–ª–∏ —ç—Ç–æ –º–æ–±)
        if (this.type === 'mob') {
           const room = this.getRoom();
           setTimeout(() => spawnMob(room), CONFIG.MOB_RESPAWN_TIME);
        }
      }
      getRoom() {
        return Math.floor(this.x / CONFIG.ROOM_SIZE) + Math.floor(this.y / CONFIG.ROOM_SIZE) * 2;
      }
      getRoomCenter(r) {
        const rx = r % 2, ry = Math.floor(r / 2);
        return { x: rx * CONFIG.ROOM_SIZE + CONFIG.ROOM_SIZE/2, y: ry * CONFIG.ROOM_SIZE + CONFIG.ROOM_SIZE/2 };
      }
      aiTick() {
        if (this.hp <= 0) return;
        const room = this.getRoom();
        const inRoom = entities.filter(e => e.getRoom() === room && e.hp > 0);
        
        // 1. –£–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ü–µ–ª—å, –µ—Å–ª–∏ –æ–Ω–∞ –∂–∏–≤–∞
        if (this.target && this.target.hp > 0) {
          if (this.distTo(this.target) < CONFIG.ATTACK_RANGE) {
             this.attack(this.target);
          } else {
             this.moveTo(this.target.x, this.target.y, 2);
          }
          return;
        } else {
            this.target = null; // –¶–µ–ª—å –º–µ—Ä—Ç–≤–∞ –∏–ª–∏ –ø–æ—Ç–µ—Ä—è–Ω–∞
        }

        // 2. –í—ã–±–æ—Ä –Ω–æ–≤–æ–π —Ü–µ–ª–∏
        if (this.type === 'gnome') {
          // –ì–Ω–æ–º —Å–ø–æ–π–ª–∏—Ç –±–ª–∏–∂–∞–π—à–µ–≥–æ –Ω–µ—Å–ø–æ–π–ª–µ–Ω–æ–≥–æ –º–æ–±–∞
          const freeMob = inRoom.find(e => e.type === 'mob' && !e.spoiled);
          if (freeMob && this.distTo(freeMob) < 400) { 
            this.target = freeMob; 
            this.spoil(freeMob); 
          }
        } else if (this.type === 'sk') {
          // –†—ã—Ü–∞—Ä—å –∏—â–µ—Ç –±–ª–∏–∂–∞–π—à–µ–≥–æ –º–æ–±–∞, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å (–∞–≥–≥—Ä–æ)
          const freeMob = inRoom.find(e => e.type === 'mob' && e.distTo(this) < 400);
          if (freeMob) this.target = freeMob;
        } else if (this.type === 'mob') {
          // –ú–æ–± –∏—â–µ—Ç –±–ª–∏–∂–∞–π—à—É—é —Ü–µ–ª—å (–∏–≥—Ä–æ–∫/gnome/sk)
          const nearest = inRoom.sort((a,b) => dist(this, a) - dist(this, b))
             .find(e => (e.type === 'player' || e.type === 'gnome' || e.type === 'sk') && dist(this, e) < 400);
          if (nearest) this.target = nearest;
        }

        // 3. –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏ –∏–ª–∏ —Ü–µ–Ω—Ç—Ä—É
        if (this.target && this.target.hp > 0) {
          if (this.distTo(this.target) > CONFIG.ATTACK_RANGE) {
             this.moveTo(this.target.x, this.target.y, 1.8);
          }
        } else {
          // –ò–¥–µ–º –≤ —Ü–µ–Ω—Ç—Ä, –µ—Å–ª–∏ –Ω–µ—Ç —Ü–µ–ª–∏
          const center = this.getRoomCenter(this.getRoom());
          this.moveTo(center.x, center.y, 1.5);
        }
      }
    }

    class Player extends Unit {
      constructor() { super(160, 160, 'player', '‚öíÔ∏è', '#ff6b6b', 250, 16, 9); }
      update() {
        let isMoving = false;
        if (joystick.active) {
          this.x += joystick.dx * CONFIG.MOVE_SPEED;
          this.y += joystick.dy * CONFIG.MOVE_SPEED;
          isMoving = true;
        }
        
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ –∫–∞—Ä—Ç–µ
        this.x = Math.max(30, Math.min(this.x, CONFIG.ROOM_SIZE*2 - 30));
        this.y = Math.max(30, Math.min(this.y, CONFIG.ROOM_SIZE*2 - 30));

        if (selectedTarget && selectedTarget.hp > 0) {
          if (this.distTo(selectedTarget) < CONFIG.ATTACK_RANGE) {
            this.attack(selectedTarget);
          } else if (!isMoving) {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –¥–∂–æ–π—Å—Ç–∏–∫ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
            this.moveTo(selectedTarget.x, selectedTarget.y, CONFIG.MOVE_SPEED * 0.8);
          }
        } else {
             selectedTarget = null;
        }
      }
    }

    // === –≠–§–§–ï–ö–¢–´ ===
    // ... (–∫–æ–¥ addEffect –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    function addEffect(x, y, text) {
      const el = document.createElement('div');
      el.className = 'spoil-effect';
      el.textContent = text;
      el.style.left = (x * CONFIG.ZOOM - camera.x * CONFIG.ZOOM) + 'px';
      el.style.top = (y * CONFIG.ZOOM - camera.y * CONFIG.ZOOM) + 'px';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1000);
    }


    // === –ò–ù–ò–¢ ===
    function init() {
      entities = [];
      player = new Player();
      for (let i = 0; i < 4; i++) {
        const c = player.getRoomCenter(i);
        new Unit(c.x-40, c.y, 'gnome', 'üßô', '#ffd700', 160, 13, 7);
        new Unit(c.x+40, c.y, 'gnome', 'üßô', '#ffd700', 160, 13, 7);
        new Unit(c.x, c.y+50, 'sk', 'üõ°Ô∏è', '#00ff88', 280, 19, 11);
        for (let j = 0; j < 3; j++) spawnMob(i);
      }
      
      // –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ —Ä–µ—Å–ø–∞—É–Ω–∞ –º–æ–±–æ–≤
      if (mobSpawnInterval) clearInterval(mobSpawnInterval);
      mobSpawnInterval = setInterval(spawnMob, CONFIG.MOB_RESPAWN_TIME);
    }

    function spawnMob(room = Math.floor(Math.random()*4)) {
      const mobsInRoom = entities.filter(e => e.type === 'mob' && e.getRoom() === room).length;
      if (mobsInRoom >= 4) return; 

      const c = player.getRoomCenter(room);
      const newMob = new Unit(
         c.x + Math.random()*80-40, 
         c.y + Math.random()*80-40, 
         'mob', 
         Math.random() > 0.5 ? 'üíÄ' : 'üëπ', 
         '#ff4444', 90, 9, 5
      );
      // –ï—Å–ª–∏ –Ω–æ–≤—ã–π –º–æ–± ‚Äî –±–ª–∏–∂–∞–π—à–∞—è —Ü–µ–ª—å, –≤—ã–¥–µ–ª—è–µ–º –µ–≥–æ
      if (!selectedTarget) selectedTarget = newMob;
    }

    function dist(a,b) { return Math.hypot(a.x-b.x, a.y-b.y); }

    function log(msg, color='#fff') {
      const d = document.createElement('div');
      d.textContent = msg;
      d.style.color = color;
      logEl.prepend(d); // –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–≤–µ—Ä—Ö—É
      // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ª–æ–≥–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è DOM
      while (logEl.children.length > 50) {
        logEl.removeChild(logEl.lastChild);
      }
    }

    function checkLevel() {
      // ... (–ª–æ–≥–∏–∫–∞ —É—Ä–æ–≤–Ω–µ–π –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
      if (pet.exp >= pet.expToNext) { 
        pet.level++; 
        pet.exp = pet.exp - pet.expToNext; 
        pet.expToNext = pet.expToNext * 1.5; 
        log('–£–†–û–í–ï–ù–¨ UP!', '#00ff00'); 
      }
      if (pet.spoilExp >= pet.spoilToNext) { 
        pet.spoilLevel++; 
        pet.spoilExp = pet.spoilExp - pet.spoilToNext; 
        pet.spoilToNext = pet.spoilToNext * 1.5; 
        log('–°–ü–û–ô–õ UP!', '#ffd700'); 
      }
      document.getElementById('level').textContent = pet.level;
      document.getElementById('expBar').style.width = (pet.exp / pet.expToNext * 100) + '%';
      document.getElementById('spoilLevel').textContent = pet.spoilLevel;
      document.getElementById('spoilBar').style.width = (pet.spoilExp / pet.spoilToNext * 100) + '%';
      document.getElementById('adena').textContent = pet.adena;
      document.getElementById('crystals').textContent = pet.crystals;
      document.getElementById('mats').textContent = pet.mats;
      if (pet.adena >= CONFIG.GOAL_ADENA) { log('–¢–´ ‚Äî –ú–ê–°–¢–ï–† –°–ü–û–ô–õ–ê!', '#ffd700'); }
    }
    
    function checkSpoil() { checkLevel(); } 

    function reset() { init(); }

    // === –†–ï–ù–î–ï–† ===
    function render() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.save();
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–∞–º–µ—Ä—É
      ctx.translate(-camera.x * CONFIG.ZOOM, -camera.y * CONFIG.ZOOM);
      ctx.scale(CONFIG.ZOOM, CONFIG.ZOOM);

      // –ö–∞—Ä—Ç–∞
      ctx.fillStyle = '#222';
      ctx.fillRect(0,0,CONFIG.ROOM_SIZE*2,CONFIG.ROOM_SIZE*2);
      ctx.strokeStyle = '#555';
      ctx.lineWidth = 4;
      for (let i=0; i<=2; i++) {
        ctx.beginPath();
        ctx.moveTo(i*CONFIG.ROOM_SIZE, 0);
        ctx.lineTo(i*CONFIG.ROOM_SIZE, CONFIG.ROOM_SIZE*2);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, i*CONFIG.ROOM_SIZE);
        ctx.lineTo(CONFIG.ROOM_SIZE*2, i*CONFIG.ROOM_SIZE);
        ctx.stroke();
      }

      // –Æ–Ω–∏—Ç—ã
      entities.forEach(e => {
        if (e.hp <= 0) return;
        
        // 1. –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–ª–∏
        if (e === selectedTarget) {
          ctx.strokeStyle = '#ffff00';
          ctx.lineWidth = 3;
          ctx.beginPath(); ctx.arc(e.x, e.y, 25, 0, Math.PI*2); ctx.stroke();
          
           // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–∞–ª—å–Ω–æ—Å—Ç–∏ –∞—Ç–∞–∫–∏ –∏–≥—Ä–æ–∫–∞
           if (e.type === 'mob') {
                ctx.strokeStyle = 'rgba(255, 0, 0, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.arc(player.x, player.y, CONFIG.ATTACK_RANGE, 0, Math.PI*2); ctx.stroke();
                
                ctx.strokeStyle = 'rgba(255, 255, 0, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.arc(player.x, player.y, CONFIG.SPOIL_RANGE, 0, Math.PI*2); ctx.stroke();
           }
        }
        
        // 2. –°–∏–º–≤–æ–ª
        ctx.font = '36px Arial';
        ctx.fillText(e.symbol, e.x, e.y + 2);
        
        // 3. –ü–æ–ª–æ—Å–∞ HP
        ctx.fillStyle = '#ff0000';
        ctx.fillRect(e.x-22, e.y-35, 44, 6);
        ctx.fillStyle = '#00ff00';
        ctx.fillRect(e.x-22, e.y-35, 44*(e.hp/e.maxHp), 6);
        
        // 4. –ú–µ—Ç–∫–∞ Spoiled
        if (e.spoiled) {
           ctx.fillStyle = '#ffd700';
           ctx.font = '10px Arial';
           ctx.fillText('SPOIL', e.x, e.y - 40);
        }
      });

      ctx.restore();
    }

    function updateCamera() {
      // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—É–¥–∞ –¥–æ–ª–∂–Ω–∞ —Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–º–µ—Ä–∞
      camera.targetX = player.x - canvas.width/(2*CONFIG.ZOOM);
      camera.targetY = player.y - canvas.height/(2*CONFIG.ZOOM);
      
      // 2. –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
      camera.x += (camera.targetX - camera.x) * CONFIG.CAMERA_SMOOTHING;
      camera.y += (camera.targetY - camera.y) * CONFIG.CAMERA_SMOOTHING;
      
      // 3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
      const maxCamX = CONFIG.ROOM_SIZE*2 - canvas.width/CONFIG.ZOOM;
      const maxCamY = CONFIG.ROOM_SIZE*2 - canvas.height/CONFIG.ZOOM;
      
      camera.x = Math.max(0, Math.min(camera.x, maxCamX));
      camera.y = Math.max(0, Math.min(camera.y, maxCamY));
    }

    // === –õ–£–ü ===
    function loop() {
      player.update();
      entities.forEach(e => { if (e !== player && e.hp > 0) e.aiTick(); });
      updateCamera();
      render();
      requestAnimationFrame(loop);
    }

    // === –ö–õ–ò–ö –ü–û –ú–û–ë–£ ===
    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const tx = (e.touches[0].clientX - rect.left) / CONFIG.ZOOM + camera.x;
      const ty = (e.touches[0].clientY - rect.top) / CONFIG.ZOOM + camera.y;
      
      // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é —Ü–µ–ª—å –≤ —Ä–∞–¥–∏—É—Å–µ 40 (—É—á–∏—Ç—ã–≤–∞—è —Å–º–µ—â–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞/—Å–∏–º–≤–æ–ª–∞)
      selectedTarget = entities.find(ent => ent !== player && ent.hp > 0 && dist(ent, {x:tx, y:ty}) < 40);
    });

    init();
    loop();
  </script>
</body>
</html>
