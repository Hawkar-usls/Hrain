<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>HRAIN Mobile v2 (Saved)</title>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #f4f7f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;
            overscroll-behavior: none;
        }
        #logo {
            position: absolute; top: 50px; left: 20px;
            font-size: 1.5rem; font-weight: 800; color: #333;
            pointer-events: none; z-index: 10; opacity: 0.8;
        }
        #chart { width: 100%; height: 100%; touch-action: none; }
        line.link { stroke: #b0b8c0; stroke-width: 2px; opacity: 0.6; }
        circle.node {
            fill: #ffffff; stroke: #333; stroke-width: 2px;
            transition: fill 0.2s, stroke 0.2s, stroke-width 0.2s;
        }
        circle.node.selected { fill: #ffe082; stroke: #ffca28; stroke-width: 4px; }
        text.label {
            font-size: 14px; fill: #333; pointer-events: none;
            text-anchor: middle; font-weight: 600;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }
        #action-menu-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 1000; display: none;
            align-items: center; justify-content: center; backdrop-filter: blur(3px);
        }
        #action-menu {
            background: white; width: 280px; border-radius: 20px; padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center;
            display: flex; flex-direction: column; gap: 10px;
        }
        #menu-title { margin: 0 0 10px 0; font-size: 1.2rem; color: #333; }
        .menu-btn {
            padding: 12px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
        }
        .btn-edit { background: #e3f2fd; color: #1976d2; }
        .btn-delete { background: #ffebee; color: #c62828; }
        .btn-cancel { background: #f5f5f5; color: #666; margin-top: 5px;}
        
        /* –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏–ª–∏ –æ—á–∏—Å—Ç–∫–∏) */
        #reset-btn {
            position: absolute; bottom: 20px; right: 20px;
            font-size: 0.8rem; color: #999; background: none; border: none;
            z-index: 5;
        }
    </style>
</head>
<body>

    <div id="logo">üß† HRAIN <span style="font-weight:400; font-size: 0.8em;">v2.0</span></div>
    <button id="reset-btn" onclick="clearAllData()">–°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö</button>

    <div id="action-menu-backdrop">
        <div id="action-menu">
            <h3 id="menu-title">–î–µ–π—Å—Ç–≤–∏—è</h3>
            <button class="menu-btn btn-edit" onclick="renameCurrentNode()">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
            <button class="menu-btn btn-delete" onclick="deleteCurrentNode()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            <button class="menu-btn btn-cancel" onclick="closeMenu()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="chart"></div>

<script>
    // === 0. –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ===
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage
    function loadData() {
        const saved = localStorage.getItem('hrain_d3_data');
        if (saved) {
            try {
                return JSON.parse(saved);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö", e);
                return null;
            }
        }
        return null;
    }

    // –ù–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ)
    const initialData = loadData() || {
        nodes: [
            { id: 1, label: "–ò–¥–µ—è", x: window.innerWidth/2, y: window.innerHeight/2 }
        ],
        links: []
    };

    let nodes = initialData.nodes;
    let links = initialData.links;

    // === 1. –ù–ê–°–¢–†–û–ô–ö–ò D3 ===
    const width = window.innerWidth;
    const height = window.innerHeight;
    let selectedNode = null;
    let menuNode = null;
    let lastTapTime = 0;
    let longPressTimer;

    const svg = d3.select("#chart").append("svg")
        .attr("width", width).attr("height", height)
        .attr("viewBox", [0, 0, width, height]);

    const g = svg.append("g");
    const linkGroup = g.append("g").attr("class", "links");
    const nodeGroup = g.append("g").attr("class", "nodes");
    const textGroup = g.append("g").attr("class", "texts");

    const zoom = d3.zoom().scaleExtent([0.2, 5]).on("zoom", (event) => {
        g.attr("transform", event.transform);
    });
    svg.call(zoom).on("dblclick.zoom", null);

    // –§–∏–∑–∏–∫–∞
    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(130))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("collide", d3.forceCollide().radius(d => (d.radius || 30) + 10).iterations(2));
        // –£–±—Ä–∞–ª–∏ forceCenter, —á—Ç–æ–±—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —à–∞—Ä—ã –Ω–µ —É–ª–µ—Ç–∞–ª–∏ –≤ —Ü–µ–Ω—Ç—Ä, –µ—Å–ª–∏ –º—ã –∏—Ö —Ä–∞—Å—Ç–∞—â–∏–ª–∏

    // === 2. –°–û–•–†–ê–ù–ï–ù–ò–ï ===
    function saveData() {
        // D3 –¥–æ–±–∞–≤–ª—è–µ—Ç –∫—É—á—É –º—É—Å–æ—Ä–∞ –≤ –æ–±—ä–µ–∫—Ç—ã (vx, vy, index...). 
        // –ù–∞–º –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å—É—Ç—å.
        const cleanNodes = nodes.map(n => ({
            id: n.id,
            label: n.label,
            x: n.x, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é!
            y: n.y
        }));

        const cleanLinks = links.map(l => ({
            source: l.source.id, // D3 –∑–∞–º–µ–Ω—è–µ—Ç source –Ω–∞ –æ–±—ä–µ–∫—Ç, –Ω–∞–º –Ω—É–∂–µ–Ω ID –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            target: l.target.id
        }));

        const dataToSave = { nodes: cleanNodes, links: cleanLinks };
        localStorage.setItem('hrain_d3_data', JSON.stringify(dataToSave));
        console.log("Saved!");
    }
    
    function clearAllData() {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ?")) {
            localStorage.removeItem('hrain_d3_data');
            location.reload();
        }
    }

    // === 3. –û–ë–ù–û–í–õ–ï–ù–ò–ï (UPDATE) ===
    function update() {
        // –ê–≤—Ç–æ-—Ä–∞–∑–º–µ—Ä
        nodes.forEach(node => {
            const connections = links.filter(l => l.source.id === node.id || l.target.id === node.id).length;
            node.radius = 30 + (connections * 5);
        });

        // –õ–∏–Ω–∏–∏
        const link = linkGroup.selectAll("line")
            .data(links, d => (d.source.id || d.source) + "-" + (d.target.id || d.target));
        link.exit().remove();
        const linkEnter = link.enter().append("line").attr("class", "link");
        const allLinks = linkEnter.merge(link);

        // –®–∞—Ä—ã
        const node = nodeGroup.selectAll("circle").data(nodes, d => d.id);
        node.exit().transition().duration(300).attr("r", 0).remove();
        const nodeEnter = node.enter().append("circle")
            .attr("class", "node")
            .attr("r", 0)
            .call(d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended))
            .on("touchstart", handleTouchStart)
            .on("touchend", handleTouchEnd)
            .on("click", handleNodeClick);
        const allNodes = nodeEnter.merge(node);
        
        allNodes.transition().duration(300)
            .attr("r", d => d.radius)
            .attr("class", d => d === selectedNode ? "node selected" : "node");

        // –¢–µ–∫—Å—Ç
        const text = textGroup.selectAll("text").data(nodes, d => d.id);
        text.exit().remove();
        const textEnter = text.enter().append("text")
            .attr("class", "label")
            .attr("dy", 5).text(d => d.label);
        const allTexts = textEnter.merge(text).text(d => d.label);

        simulation.nodes(nodes).on("tick", () => {
            allLinks
                .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            allNodes.attr("cx", d => d.x).attr("cy", d => d.y);
            allTexts.attr("x", d => d.x).attr("y", d => d.y);
        });
        
        simulation.force("link").links(links);
        simulation.alpha(0.3).restart(); // –õ–µ–≥–∫–∏–π —Ç–æ–ª—á–æ–∫ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        
        // ! –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        saveData();
    }

    // === 4. –õ–û–ì–ò–ö–ê ===

    svg.on("touchstart", (event) => {
        if (event.target.tagName === "circle") return;
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTapTime;
        if (tapLength < 300 && tapLength > 0) {
            event.preventDefault();
            const transform = d3.zoomTransform(svg.node());
            const touch = event.touches[0];
            const [x, y] = transform.invert([touch.clientX, touch.clientY]);
            nodes.push({ id: Date.now(), label: "...", x: x, y: y });
            update();
        }
        lastTapTime = currentTime;
    });

    function handleTouchStart(event, d) {
        longPressTimer = setTimeout(() => openMenu(d), 600);
    }
    function handleTouchEnd(event, d) {
        if (longPressTimer) clearTimeout(longPressTimer);
    }

    function handleNodeClick(event, d) {
        if (event.defaultPrevented) return;
        if (selectedNode === null) {
            selectedNode = d;
        } else if (selectedNode === d) {
            selectedNode = null;
        } else {
            const exists = links.some(l => 
                (l.source.id === selectedNode.id && l.target.id === d.id) ||
                (l.source.id === d.id && l.target.id === selectedNode.id)
            );
            if (!exists) {
                links.push({ source: selectedNode.id, target: d.id });
            } else {
                links = links.filter(l => 
                    !((l.source.id === selectedNode.id && l.target.id === d.id) ||
                      (l.source.id === d.id && l.target.id === selectedNode.id))
                );
            }
            selectedNode = null;
        }
        update();
    }

    // –ú–µ–Ω—é
    const menuBackdrop = document.getElementById('action-menu-backdrop');
    const menuTitle = document.getElementById('menu-title');

    function openMenu(d) {
        menuNode = d;
        if (navigator.vibrate) navigator.vibrate(50);
        menuTitle.textContent = `–£–∑–µ–ª: "${d.label}"`;
        menuBackdrop.style.display = 'flex';
    }
    function closeMenu() {
        menuBackdrop.style.display = 'none';
        menuNode = null;
    }
    function renameCurrentNode() {
        if (!menuNode) return;
        const newName = prompt("–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:", menuNode.label);
        if (newName) {
            menuNode.label = newName;
            update();
        }
        closeMenu();
    }
    function deleteCurrentNode() {
        if (!menuNode) return;
        if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —É–∑–µ–ª?")) {
            nodes = nodes.filter(n => n.id !== menuNode.id);
            links = links.filter(l => l.source.id !== menuNode.id && l.target.id !== menuNode.id);
            if (selectedNode === menuNode) selectedNode = null;
            update();
        }
        closeMenu();
    }

    // Drag & Drop + Save position on end
    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
        if (longPressTimer) clearTimeout(longPressTimer);
    }
    function dragged(event, d) {
        d.fx = event.x; d.fy = event.y;
    }
    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null; d.fy = null;
        saveData(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    }

    update();

</script>
</body>
</html>
